<!DOCTYPE html>
<html lang="he" dir="rtl" class="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>ShmoopsiePoo - Finance Tracker</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'], mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'monospace'] },
        colors: {
          gray: { 50: '#fafafa', 100: '#f4f4f5', 200: '#e4e4e7', 300: '#d4d4d8', 400: '#a1a1aa', 500: '#71717a', 600: '#52525b', 700: '#3f3f46', 800: '#27272a', 900: '#18181b', 950: '#09090b' },
          primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
          success: { 500: '#10b981', 600: '#059669' },
          danger: { 500: '#f43f5e', 600: '#e11d48' },
        }
      }
    }
  }
</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
  ::-webkit-scrollbar{display:none}
  .no-tap{-webkit-tap-highlight-color:transparent}
  body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
  @keyframes stickerPop {
    0% { transform: scale(0) rotate(-20deg); opacity: 0; }
    15% { transform: scale(1.2) rotate(10deg); opacity: 1; }
    85% { transform: scale(1.1) rotate(0deg); opacity: 1; }
    100% { transform: scale(0) rotate(20deg); opacity: 0; }
  }
  .sticker-anim { animation: stickerPop 2.0s ease-out forwards; }
</style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-950 dark:text-gray-100 font-sans transition-colors duration-300 pb-24 selection:bg-primary-500 selection:text-white">

<!-- Sticker Overlay -->
<div id="stickerOverlay" class="fixed inset-0 z-[100] hidden items-center justify-center pointer-events-none">
  <img src="◊°◊ò◊ô◊ß◊®.58" class="w-64 h-64 sticker-anim drop-shadow-2xl" onerror="this.src='https://cdn-icons-png.flaticon.com/512/7486/7486747.png'">
</div>

<!-- Login Screen -->
<div id="loginScreen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-50 dark:bg-gray-950 p-6">
  <div class="w-full max-w-sm bg-white dark:bg-gray-900 p-8 rounded-2xl shadow-[0_8px_30px_rgb(0,0,0,0.04)] border border-gray-200 dark:border-gray-800 text-center">
    <div class="w-16 h-16 bg-primary-50 dark:bg-primary-900/20 rounded-2xl flex items-center justify-center mx-auto mb-6 text-3xl">üí∞</div>
    <h1 class="text-2xl font-bold mb-2 text-gray-900 dark:text-white tracking-tight">ShmoopsiePoo</h1>
    <p class="text-gray-500 dark:text-gray-400 mb-8 text-sm">Financial Intelligence for Yael & Amit</p>
    <div id="loginErr" class="hidden mb-4 p-3 bg-danger-50 text-danger-600 border border-danger-100 rounded-lg text-xs"></div>
    <button onclick="doGoogleLogin()" class="w-full py-3 px-4 bg-white dark:bg-gray-800 text-gray-700 dark:text-white border border-gray-200 dark:border-gray-700 rounded-xl font-semibold text-sm hover:bg-gray-50 dark:hover:bg-gray-700 transition flex items-center justify-center gap-3 active:scale-[0.98]">
      <svg width="18" height="18" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
      Continue with Google
    </button>
  </div>
</div>

<div id="mainApp" style="display:none">

  <!-- Header -->
  <header class="sticky top-0 z-40 w-full bg-white/90 dark:bg-gray-950/90 backdrop-blur-lg border-b border-gray-200 dark:border-gray-800">
    <div class="flex items-center justify-between px-4 py-3 pt-safe-top">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 rounded-lg bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-sm">üí∞</div>
        <div>
          <h1 class="text-sm font-bold text-gray-900 dark:text-white leading-none">ShmoopsiePoo</h1>
          <p class="text-[10px] text-gray-500 uppercase tracking-wider font-medium mt-0.5">Yael & Amit</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button onclick="toggleTheme()" id="themeBtn" class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-800 transition">üåô</button>
        <button onclick="firebase.auth().signOut()" class="p-2 rounded-lg text-danger-500 hover:bg-danger-50 dark:hover:bg-danger-900/20 transition">üö™</button>
      </div>
    </div>
    <div id="pLbl" class="px-4 pb-2 text-[10px] font-mono text-gray-400 text-right tracking-tight"></div>
  </header>

  <!-- Filter Bar -->
  <div class="bg-white dark:bg-gray-950 border-b border-gray-200 dark:border-gray-800 px-4 py-3 space-y-3">
    <div class="flex items-center gap-2 bg-gray-50 dark:bg-gray-900 p-1 rounded-lg border border-gray-200 dark:border-gray-800">
      <input type="date" id="sd" class="flex-1 min-w-0 bg-transparent text-gray-600 dark:text-gray-300 text-xs py-1.5 px-2 font-mono outline-none">
      <span class="text-gray-300">‚Üí</span>
      <input type="date" id="ed" class="flex-1 min-w-0 bg-transparent text-gray-600 dark:text-gray-300 text-xs py-1.5 px-2 font-mono outline-none">
      <button onclick="applyFilter()" class="bg-primary-600 hover:bg-primary-700 text-white text-xs font-semibold py-1.5 px-3 rounded-md transition shadow-sm">Filter</button>
    </div>
    <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar" id="presets">
      <!-- Presets injected via JS -->
    </div>
  </div>

  <!-- Content Area -->
  <main class="p-4 space-y-5 max-w-2xl mx-auto">

    <!-- Page: Summary -->
    <div id="pgS" class="pg hidden">
      <div id="kpis" class="grid grid-cols-2 gap-3 mb-5"></div>
      
      <div id="sBox" class="bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 rounded-xl p-4 shadow-sm mb-5"></div>
      
      <div class="bg-white dark:bg-gray-900 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-800 mb-5">
        <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-4">Cash Flow Analysis</h3>
        <div id="mChart" class="flex items-end justify-between gap-2 h-40 pt-4 border-b border-gray-100 dark:border-gray-800"></div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-5 mb-5">
        <div class="bg-white dark:bg-gray-900 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-800">
          <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-4">Income Sources</h3>
          <div class="flex items-center gap-6">
            <div id="donut" class="w-28 h-28 rounded-full relative shrink-0"></div>
            <div id="piLg" class="flex-1 space-y-1.5"></div>
          </div>
        </div>

        <div class="bg-white dark:bg-gray-900 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-800">
          <h3 class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-4">Top Spending</h3>
          <div id="eCats" class="space-y-3"></div>
        </div>
      </div>

      <div id="updTime" class="text-[10px] text-center text-gray-400 font-medium py-2"></div>
      
      <button onclick="shareWhatsApp()" class="fixed bottom-24 right-5 w-12 h-12 bg-[#25D366] text-white rounded-full shadow-lg shadow-green-500/20 flex items-center justify-center text-xl transition transform active:scale-95 z-30 ring-2 ring-white dark:ring-gray-900">
        üì≤
      </button>
    </div>

    <!-- Page: Income -->
    <div id="pgI" class="pg hidden">
      <div class="sticky top-[138px] z-30 bg-gray-50 dark:bg-gray-950 pb-3">
        <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
            <input id="iSr" placeholder="Search income records..." oninput="rInc()" class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-sm rounded-xl pl-10 pr-4 py-2.5 shadow-sm focus:ring-2 focus:ring-primary-500/20 focus:border-primary-500 focus:outline-none transition-all">
        </div>
      </div>
      <div id="sumI" class="flex justify-between bg-white dark:bg-gray-900 p-4 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm text-center mb-4 divide-x divide-x-reverse divide-gray-100 dark:divide-gray-800"></div>
      <div class="flex flex-wrap gap-2 mb-4" id="iCh"></div>
      <div class="text-[10px] text-gray-400 mb-2 font-mono uppercase tracking-wide" id="iCn"></div>
      <div id="iLs" class="space-y-2"></div>
      <button onclick="openModal('income')" class="fixed bottom-24 left-5 w-12 h-12 bg-primary-600 text-white rounded-full shadow-lg shadow-primary-500/30 flex items-center justify-center text-2xl transition transform active:scale-95 z-30 ring-2 ring-white dark:ring-gray-900">+</button>
    </div>

    <!-- Page: Expense -->
    <div id="pgE" class="pg hidden">
      <div class="sticky top-[138px] z-30 bg-gray-50 dark:bg-gray-950 pb-3">
         <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
            <input id="eSr" placeholder="Search expense records..." oninput="rExp()" class="w-full bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-800 text-sm rounded-xl pl-10 pr-4 py-2.5 shadow-sm focus:ring-2 focus:ring-danger-500/20 focus:border-danger-500 focus:outline-none transition-all">
        </div>
      </div>
      <div id="sumE" class="flex justify-between bg-white dark:bg-gray-900 p-4 rounded-xl border border-gray-200 dark:border-gray-800 shadow-sm text-center mb-4 divide-x divide-x-reverse divide-gray-100 dark:divide-gray-800"></div>
      <div class="flex flex-wrap gap-2 mb-4" id="eCh"></div>
      <div class="text-[10px] text-gray-400 mb-2 font-mono uppercase tracking-wide" id="eCn"></div>
      <div id="eLs" class="space-y-2"></div>
      <button onclick="openModal('expense')" class="fixed bottom-24 left-5 w-12 h-12 bg-danger-600 text-white rounded-full shadow-lg shadow-danger-500/30 flex items-center justify-center text-xl transition transform active:scale-95 z-30 ring-2 ring-white dark:ring-gray-900">üí∏</button>
    </div>

    <!-- Page: Tools/Categories -->
    <div id="pgT" class="pg hidden">
      <div class="bg-white dark:bg-gray-900 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-800 mb-5">
        <h3 class="text-xs font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2 uppercase tracking-wide">
           <span class="text-lg">üí°</span> Smart Insights
        </h3>
        <div id="insightsBox" class="space-y-3"></div>
      </div>
      
      <div class="bg-white dark:bg-gray-900 rounded-xl p-5 shadow-sm border border-gray-200 dark:border-gray-800">
        <h3 class="text-xs font-bold text-gray-900 dark:text-white mb-4 flex items-center gap-2 uppercase tracking-wide">
            <span class="text-lg">üè∑Ô∏è</span> Manage Categories
        </h3>
        <div id="catList" class="space-y-2 mb-4"></div>
        <div class="flex gap-2 mb-6">
          <input type="text" id="newCatPageInput" placeholder="Create new category..." class="flex-1 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500 outline-none transition-all">
          <button onclick="addCatFromPage()" class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm">Add</button>
        </div>
        <button onclick="deleteAllCats()" class="w-full py-3 bg-danger-50 dark:bg-danger-900/10 text-danger-600 dark:text-danger-400 rounded-xl text-sm font-bold border border-danger-100 dark:border-danger-900 transition hover:bg-danger-100">üóëÔ∏è Reset All Categories</button>
      </div>
    </div>

  </main>

  <!-- Transaction Modal -->
  <div id="addModal" class="fixed inset-0 z-[60] hidden items-center justify-center bg-gray-900/40 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-900 w-full max-w-sm rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-800 overflow-hidden flex flex-col max-h-[90vh]">
      <div class="p-5 border-b border-gray-100 dark:border-gray-800 bg-gray-50/50 dark:bg-gray-900">
        <h3 class="text-base font-bold text-center text-gray-900 dark:text-white" id="modalTitle">Add Item</h3>
      </div>
      
      <div class="p-6 overflow-y-auto space-y-5">
        <!-- Scan Button -->
        <div>
          <input type="file" id="receiptFile" accept="image/*" class="hidden" onchange="scanReceipt(this)">
          <button onclick="document.getElementById('receiptFile').click()" id="scanBtn" class="w-full py-3 bg-gradient-to-r from-primary-600 to-indigo-600 text-white rounded-xl text-sm font-bold shadow-md hover:shadow-lg transition flex items-center justify-center gap-2 group">
            <span class="group-hover:scale-110 transition-transform">üì∑</span> AI Receipt Scan
          </button>
          <div id="scanStatus" class="text-xs text-center mt-2 hidden"></div>
        </div>

        <!-- Inputs -->
        <div class="space-y-4">
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1.5">Date</label>
                <input type="date" id="nDate" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 dark:text-white">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1.5">Amount</label>
                <input type="number" id="nAmt" placeholder="0.00" inputmode="numeric" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2.5 text-xl font-mono font-medium outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 dark:text-white">
            </div>
            <div>
                <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-1.5">Description</label>
                <input type="text" id="nDesc" placeholder="What is it?" class="w-full bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2.5 text-sm outline-none focus:ring-2 focus:ring-primary-500 text-gray-900 dark:text-white">
            </div>
        </div>
        
        <div>
          <label class="block text-[10px] font-bold text-gray-500 uppercase tracking-wider mb-2">Category</label>
          <div class="flex flex-wrap gap-2 mb-3 max-h-32 overflow-y-auto p-1" id="modalCats"></div>
          <div class="flex gap-2">
            <input type="text" id="newCatInput" placeholder="New category..." class="flex-1 bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-xs outline-none focus:ring-2 focus:ring-primary-500">
            <button onclick="addNewCat()" class="bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 px-3 py-2 rounded-lg font-bold text-xs hover:bg-gray-300 dark:hover:bg-gray-600 transition">Add</button>
          </div>
        </div>
      </div>

      <div class="p-5 bg-gray-50 dark:bg-gray-900/50 border-t border-gray-100 dark:border-gray-800 flex gap-3">
        <button onclick="closeModal()" class="flex-1 py-2.5 rounded-lg font-bold text-sm bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">Cancel</button>
        <button id="saveBtn" onclick="saveItem()" class="flex-1 py-2.5 rounded-lg font-bold text-sm bg-primary-600 text-white shadow-md shadow-primary-500/20 hover:bg-primary-700 transition">Save Item</button>
      </div>
    </div>
  </div>

  <!-- Edit Category Modal -->
  <div id="editCatModal" class="fixed inset-0 z-[70] hidden items-center justify-center bg-gray-900/40 backdrop-blur-sm p-4">
    <div class="bg-white dark:bg-gray-800 w-full max-w-xs rounded-2xl p-6 shadow-2xl border border-gray-200 dark:border-gray-700">
      <h3 class="text-base font-bold text-center mb-4 text-gray-900 dark:text-white">Rename Category</h3>
      <input type="text" id="editCatName" class="w-full bg-gray-50 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2.5 text-sm mb-4 outline-none focus:ring-2 focus:ring-primary-500">
      <div class="flex gap-3">
        <button onclick="closeEditCat()" class="flex-1 py-2 rounded-lg text-sm font-bold bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300">Cancel</button>
        <button onclick="saveEditCat()" class="flex-1 py-2 rounded-lg text-sm font-bold bg-primary-600 text-white">Update</button>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <nav class="fixed bottom-0 left-0 right-0 z-50 bg-white/90 dark:bg-gray-950/90 backdrop-blur-xl border-t border-gray-200 dark:border-gray-800 pb-safe-bottom">
    <div class="flex justify-around items-center h-16">
      <button id="n0" onclick="go('S')" class="flex flex-col items-center justify-center w-full h-full transition-all text-primary-600 dark:text-primary-400">
        <span class="text-xl mb-1">üìä</span>
        <span class="text-[10px] font-bold tracking-wide">Overview</span>
      </button>
      <button id="n1" onclick="go('I')" class="flex flex-col items-center justify-center w-full h-full transition-all text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
        <span class="text-xl mb-1">üí∞</span>
        <span class="text-[10px] font-bold tracking-wide">Income</span>
      </button>
      <button id="n2" onclick="go('E')" class="flex flex-col items-center justify-center w-full h-full transition-all text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
        <span class="text-xl mb-1">üí∏</span>
        <span class="text-[10px] font-bold tracking-wide">Expense</span>
      </button>
      <button id="n3" onclick="go('T')" class="flex flex-col items-center justify-center w-full h-full transition-all text-gray-400 hover:text-gray-600 dark:hover:text-gray-200">
        <span class="text-xl mb-1">‚öôÔ∏è</span>
        <span class="text-[10px] font-bold tracking-wide">Manage</span>
      </button>
    </div>
  </nav>

</div>

<script>
/* Firebase Config */
firebase.initializeApp({
  apiKey:"AIzaSyDX0XDsaB5_JEDH7chBGMVyeUeqPnpwVlE",
  authDomain:"shmoopsiepoo1202.firebaseapp.com",
  databaseURL:"https://shmoopsiepoo1202-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"shmoopsiepoo1202",
  storageBucket:"shmoopsiepoo1202.firebasestorage.app",
  messagingSenderId:"589285900622",
  appId:"1:589285900622:web:1ac7d9b5181266f20b1e1f"
});
const db=firebase.database(),dbRef=db.ref('shmoopsiepoo');
const ALLOWED_EMAILS = { 'goreshnikamit@gmail.com': 'Amit', 'yaelzviy@gmail.com': 'Yael' };

/* Theme Init */
if (localStorage.getItem('sp_theme') === 'light') {
  document.documentElement.classList.remove('dark');
  document.getElementById('themeBtn').textContent = 'üåô';
} else {
  document.documentElement.classList.add('dark');
  document.getElementById('themeBtn').textContent = '‚òÄÔ∏è';
}

// Modern SaaS palette constants
const IC=['#6366f1','#8b5cf6','#ec4899','#f43f5e','#f59e0b','#10b981']; // Indigo, Violet, Pink, Rose, Amber, Emerald
const EC=['#f43f5e','#f97316','#f59e0b','#84cc16','#10b981','#06b6d4','#3b82f6','#6366f1'];
const MH=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

let currentUser='',s1='',s2='',curPg='S',curType='income',modalCat='',editId=null;
let iCt='◊î◊õ◊ú',eCt='◊î◊õ◊ú',editCatOld='';
let D={income:[],expense:[],categories:[]};

function showSticker() {
  const overlay = document.getElementById('stickerOverlay');
  overlay.style.display = 'flex';
  setTimeout(() => { overlay.style.display = 'none'; }, 2000);
}

firebase.auth().getRedirectResult().catch(err => {
  document.getElementById('loginErr').textContent = 'Error: ' + err.message;
  document.getElementById('loginErr').classList.remove('hidden');
});

firebase.auth().onAuthStateChanged(user => {
  if (user) {
    const email = user.email.toLowerCase();
    if (ALLOWED_EMAILS[email]) {
      currentUser = ALLOWED_EMAILS[email];
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').style.display = 'block';
      startListening();
    } else {
      document.getElementById('loginErr').textContent = 'Email ' + email + ' is not authorized.';
      document.getElementById('loginErr').classList.remove('hidden');
      firebase.auth().signOut();
    }
  } else {
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('mainApp').style.display = 'none';
  }
});

function doGoogleLogin() {
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider).catch(err => {
    if (err.code === 'auth/popup-blocked') firebase.auth().signInWithRedirect(provider);
    else { document.getElementById('loginErr').textContent = err.message; document.getElementById('loginErr').classList.remove('hidden'); }
  });
}

function toggleTheme(){
  const html = document.documentElement;
  if(html.classList.contains('dark')){
    html.classList.remove('dark');
    document.getElementById('themeBtn').textContent='üåô';
    localStorage.setItem('sp_theme','light');
  } else {
    html.classList.add('dark');
    document.getElementById('themeBtn').textContent='‚òÄÔ∏è';
    localStorage.setItem('sp_theme','dark');
  }
}

function startListening(){
  dbRef.on('value',snap=>{
    const v=snap.val()||{};
    D.income=v.income?Object.values(v.income):[];
    D.expense=v.expense?Object.values(v.expense):[];
    let cats=v.categories||[];
    if(!Array.isArray(cats))cats=Object.values(cats);
    D.categories=cats;
    D.income.sort((a,b)=>(b.d||'').localeCompare(a.d||''));
    D.expense.sort((a,b)=>(b.d||'').localeCompare(a.d||''));
    document.getElementById('updTime').textContent='Synced: '+new Date().toLocaleString('he-IL')+' ‚Ä¢ '+D.income.length+' In, '+D.expense.length+' Out';
    renderAll();
  });
  initDates();
}

function initDates(){
  const n=new Date(),y=n.getFullYear(),m=n.getMonth();
  const toI=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  s1=toI(new Date(y,m,1));s2=toI(n);
  document.getElementById('sd').value=s1;document.getElementById('ed').value=s2;
  const P=[
    {l:'This Month',s:s1,e:toI(new Date(y,m+1,0))},
    {l:'Last Month',s:`${m===0?y-1:y}-${String(m===0?12:m).padStart(2,'0')}-01`,e:`${m===0?y-1:y}-${String(m===0?12:m).padStart(2,'0')}-${new Date(m===0?y-1:y,m===0?12:m,0).getDate()}`},
    {l:'2025',s:'2025-01-01',e:'2025-12-31'},
    {l:'All Time',s:'2023-01-01',e:'2030-12-31'}
  ];
  document.getElementById('presets').innerHTML=P.map(p=>`<button class="pb whitespace-nowrap px-3 py-1.5 rounded-md text-xs font-medium border transition bg-white dark:bg-gray-900 text-gray-500 dark:text-gray-400 border-gray-200 dark:border-gray-700 hover:border-primary-500 hover:text-primary-600" onclick="sP(this,'${p.s}','${p.e}')">${p.l}</button>`).join('');
  document.querySelector('.pb').classList.add('bg-primary-50','dark:bg-primary-900/20','border-primary-200','dark:border-primary-800','text-primary-700','dark:text-primary-300');applyFilter();
}
function sP(el,a,b){
  document.querySelectorAll('.pb').forEach(x=>x.classList.remove('bg-primary-50','dark:bg-primary-900/20','border-primary-200','dark:border-primary-800','text-primary-700','dark:text-primary-300'));
  el.classList.add('bg-primary-50','dark:bg-primary-900/20','border-primary-200','dark:border-primary-800','text-primary-700','dark:text-primary-300');
  document.getElementById('sd').value=a;document.getElementById('ed').value=b;applyFilter()
}
function applyFilter(){s1=document.getElementById('sd').value;s2=document.getElementById('ed').value;document.getElementById('pLbl').textContent=new Date(s1).toLocaleDateString('he-IL')+' ‚Äî '+new Date(s2).toLocaleDateString('he-IL');iCt='◊î◊õ◊ú';eCt='◊î◊õ◊ú';renderAll()}

function fmt(n){return'‚Ç™'+Math.round(n).toLocaleString('he-IL')}
function fK(n){return n>=1e6?'‚Ç™'+(n/1e6).toFixed(1)+'M':n>=1e3?'‚Ç™'+Math.round(n/1000)+'K':'‚Ç™'+n}
function inR(d){return d>=s1&&d<=s2}
function gF(){return{inc:D.income.filter(r=>inR(r.d)),exp:D.expense.filter(r=>inR(r.d))}}
function gMC(){return Math.max(1,Math.round((new Date(s2)-new Date(s1))/(30.44*864e5)))}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}

function sumDash(id,arr,colorCls){
  const t=arr.reduce((s,x)=>s+x.a,0),c=arr.length,a=c>0?t/c:0;
  document.getElementById(id).innerHTML=`
    <div class="flex-1"><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Total</div><div class="text-xl font-bold tracking-tight ${colorCls}">${fmt(t)}</div></div>
    <div class="flex-1 border-r border-l border-gray-100 dark:border-gray-800"><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Count</div><div class="text-xl font-bold text-gray-800 dark:text-white">${c}</div></div>
    <div class="flex-1"><div class="text-[10px] text-gray-500 uppercase font-bold tracking-wider mb-1">Avg</div><div class="text-xl font-bold text-gray-800 dark:text-white">${fmt(a)}</div></div>`;
}

function shareWhatsApp(){
  const{inc,exp}=gF();
  const ti=inc.reduce((s,r)=>s+r.a,0),te=exp.reduce((s,r)=>s+r.a,0),pr=ti-te;
  const d1=new Date(s1).toLocaleDateString('he-IL'),d2=new Date(s2).toLocaleDateString('he-IL');
  let msg=`üí∞ *ShmoopsiePoo Report*\nüìÖ ${d1} - ${d2}\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\nüìä *Summary:*\n‚úÖ In: ${fmt(ti)}\n‚ùå Out: ${fmt(te)}\n${pr>=0?'üü¢':'üî¥'} Net: ${fmt(pr)}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\nSent from ShmoopsiePoo üí∞`;
  window.open('https://api.whatsapp.com/send?text='+encodeURIComponent(msg),'_blank');
}

function openModal(type,item){
  curType=type;editId=null;modalCat='';
  document.getElementById('nDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('nAmt').value='';document.getElementById('nDesc').value='';document.getElementById('newCatInput').value='';
  document.getElementById('modalTitle').textContent=type==='income'?'New Income Record':'New Expense Record';
  document.getElementById('saveBtn').textContent='Save Record';
  if(item){
    editId=item.id;document.getElementById('nDate').value=item.d;document.getElementById('nAmt').value=item.a;
    document.getElementById('nDesc').value=item.desc;modalCat=item.c||'';
    document.getElementById('modalTitle').textContent=type==='income'?'Edit Income':'Edit Expense';
    document.getElementById('saveBtn').textContent='Update Record';
  }
  renderModalCats();
  document.getElementById('addModal').classList.remove('hidden');
  document.getElementById('addModal').classList.add('flex');
}
function closeModal(){document.getElementById('addModal').classList.add('hidden');document.getElementById('addModal').classList.remove('flex');editId=null}

function renderModalCats(){
  const cats=D.categories||[];
  document.getElementById('modalCats').innerHTML=cats.map(c=>`<button class="px-3 py-1 rounded-md text-xs font-medium border transition mr-1 mb-1 ${modalCat===c?'bg-primary-100 dark:bg-primary-900/30 text-primary-700 dark:text-primary-300 border-primary-200 dark:border-primary-800 ring-1 ring-primary-500/20':'bg-white dark:bg-gray-800 text-gray-600 dark:text-gray-300 border-gray-200 dark:border-gray-700 hover:border-primary-500'}" onclick="setModalCat('${encodeURIComponent(c)}')">${esc(c)}</button>`).join('');
}
function setModalCat(c){modalCat=decodeURIComponent(c);renderModalCats()}

const GEMINI_KEY = 'AIzaSyAk2FdeJSgIZhu_6xHM9SnHOehB1EFgv3o';
async function scanReceipt(input) {
  const file = input.files[0]; if (!file) return;
  const scanBtn = document.getElementById('scanBtn'); const scanStatus = document.getElementById('scanStatus');
  scanBtn.innerHTML = '<span>‚è≥</span> Processing...'; scanBtn.disabled = true; scanStatus.classList.remove('hidden'); scanStatus.textContent = 'Sending to Gemini AI...'; scanStatus.className='text-xs text-center mt-2 text-gray-400';
  try {
    const base64 = await new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result.split(',')[1]); r.onerror = rej; r.readAsDataURL(file); });
    const prompt = `JSON ONLY: {"amount": number, "description": "hebrew string", "date": "YYYY-MM-DD", "category": "string"}. Categories: ${(D.categories||[]).join(', ')}`;
    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + GEMINI_KEY, {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ contents: [{parts: [{text: prompt},{inline_data:{mime_type:file.type||'image/jpeg',data:base64}}]}], generationConfig: {temperature: 0.0, maxOutputTokens: 500} })
    });
    const data = await response.json();
    let text = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
    const jsonMatch = text.replace(/```json\s*/gi, '').replace(/```\s*/gi, '').match(/\{[\s\S]*\}/);
    if (!jsonMatch) throw new Error('No JSON found');
    const result = JSON.parse(jsonMatch[0]);
    if (result.amount) document.getElementById('nAmt').value = result.amount;
    if (result.description) document.getElementById('nDesc').value = result.description;
    if (result.date) document.getElementById('nDate').value = result.date;
    if (result.category) { if (!(D.categories||[]).includes(result.category)) { D.categories.push(result.category); dbRef.child('categories').set(D.categories); } modalCat = result.category; renderModalCats(); }
    scanStatus.textContent = '‚úÖ Analysis Complete'; scanStatus.className='text-xs text-center mt-2 text-success-600 font-bold';
  } catch(err) {
    scanStatus.textContent = '‚ùå Analysis Failed'; scanStatus.className='text-xs text-center mt-2 text-danger-500 font-bold';
  } finally { scanBtn.innerHTML = '<span class="group-hover:scale-110 transition-transform">üì∑</span> AI Receipt Scan'; scanBtn.disabled = false; input.value = ''; }
}

function addNewCat(){
  const v=document.getElementById('newCatInput').value.trim();if(!v)return;
  const cats=D.categories||[];if(cats.includes(v)){alert('Exists');return}
  cats.push(v); D.categories=cats; dbRef.child('categories').set(cats);
  document.getElementById('newCatInput').value=''; modalCat=v; renderModalCats();
}
function saveItem(){
  const d=document.getElementById('nDate').value,a=parseFloat(document.getElementById('nAmt').value),desc=document.getElementById('nDesc').value.trim();
  if(!d||!a||a<=0||!desc){alert('Fill all fields');return}
  if(!modalCat){alert('Select category');return}
  if(editId){dbRef.child(curType).child(editId).update({d,a,desc,c:modalCat,by:currentUser})}
  else{const id=Date.now().toString();dbRef.child(curType).child(id).set({d,a,desc,c:modalCat,id,by:currentUser});
    if(curType==='income'&&typeof confetti==='function')confetti({particleCount:150,spread:70,origin:{y:0.6}, colors:['#6366f1', '#10b981']});
    if(curType==='expense') showSticker();
  }
  closeModal();
}
function deleteItem(type,id){if(confirm('Delete item?'))dbRef.child(type).child(id).remove()}
function editItem(type,id){const arr=type==='income'?D.income:D.expense;const item=arr.find(r=>r.id===id);if(item)openModal(type,item)}
function getCatCount(catName){return D.income.filter(r=>r.c===catName).length+D.expense.filter(r=>r.c===catName).length}

function addCatFromPage(){
  const v=document.getElementById('newCatPageInput').value.trim();if(!v)return;
  const cats=D.categories||[];if(cats.includes(v))return;
  cats.push(v);dbRef.child('categories').set(cats);document.getElementById('newCatPageInput').value='';
}
function deleteCat(catName){
  if(!confirm('Delete category "'+catName+'"?'))return;
  dbRef.child('categories').set((D.categories||[]).filter(c=>c!==catName));
}
function deleteAllCats(){if(confirm('Delete ALL categories?'))dbRef.child('categories').remove();}
function openEditCat(oldName){editCatOld=oldName;document.getElementById('editCatName').value=oldName;document.getElementById('editCatModal').classList.remove('hidden');document.getElementById('editCatModal').classList.add('flex')}
function closeEditCat(){document.getElementById('editCatModal').classList.add('hidden');document.getElementById('editCatModal').classList.remove('flex')}
function saveEditCat(){
  const newName=document.getElementById('editCatName').value.trim();
  if(!newName||newName===editCatOld)return;
  const cats=D.categories||[]; cats[cats.indexOf(editCatOld)]=newName; dbRef.child('categories').set(cats);
  const updates={};
  D.income.forEach(r=>{if(r.c===editCatOld)updates['income/'+r.id+'/c']=newName});
  D.expense.forEach(r=>{if(r.c===editCatOld)updates['expense/'+r.id+'/c']=newName});
  if(Object.keys(updates).length>0)dbRef.update(updates);
  closeEditCat();
}

function renderCatPage(){
  const cats=D.categories||[];
  if(!cats.length){document.getElementById('catList').innerHTML='<div class="text-center p-6 text-gray-400 text-xs italic bg-gray-50 dark:bg-gray-800/50 rounded-lg">No categories yet.</div>';return}
  document.getElementById('catList').innerHTML=cats.map(c=>{
    return`<div class="group flex items-center justify-between p-3 bg-white dark:bg-gray-800/40 rounded-lg border border-gray-100 dark:border-gray-700 hover:border-primary-200 dark:hover:border-primary-900 transition"><span class="text-sm font-medium text-gray-700 dark:text-gray-200">${esc(c)}</span><div class="flex gap-2 opacity-60 group-hover:opacity-100 transition"><button class="text-gray-400 hover:text-primary-500 edit-cat-btn" data-cat="${encodeURIComponent(c)}">‚úèÔ∏è</button><button class="text-gray-400 hover:text-danger-500 delete-cat-btn" data-cat="${encodeURIComponent(c)}">üóë</button></div></div>`;
  }).join('');
}

function mkC(r,t){
  const col=t==='i'?'text-success-600':'text-danger-600', sg=t==='i'?'+':'-', type=t==='i'?'income':'expense';
  return`<div class="group relative bg-white dark:bg-gray-900 p-4 rounded-xl border border-gray-100 dark:border-gray-800 flex justify-between items-center transition-all hover:border-gray-300 dark:hover:border-gray-600 hover:shadow-sm">
    <div class="flex-1 min-w-0 pr-4">
      <div class="font-semibold text-gray-900 dark:text-gray-100 text-sm truncate mb-1">${esc(r.desc)}</div>
      <div class="flex items-center gap-2 text-[10px]">
        <span class="text-gray-400 font-mono">${r.d}</span>
        <span class="px-1.5 py-0.5 rounded-md bg-gray-100 dark:bg-gray-800 text-gray-500 dark:text-gray-400 border border-gray-200 dark:border-gray-700">${esc(r.c)}</span>
        ${r.by?`<span class="text-gray-300">‚Ä¢ ${esc(r.by)}</span>`:''}
      </div>
    </div>
    <div class="flex flex-col items-end gap-1">
      <div class="font-mono font-bold ${col} text-sm tracking-tight">${sg}${fmt(r.a)}</div>
      <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity absolute top-2 right-2 bg-white dark:bg-gray-900 shadow-sm border border-gray-100 dark:border-gray-800 rounded-lg p-1 scale-90">
        <button onclick="editItem('${type}','${r.id}')" class="p-1 text-gray-400 hover:text-primary-500">‚úèÔ∏è</button>
        <button onclick="deleteItem('${type}','${r.id}')" class="p-1 text-gray-400 hover:text-danger-500">üóë</button>
      </div>
    </div>
  </div>`;
}

function renderAll(){
  const{inc,exp}=gF();
  const ti=inc.reduce((s,r)=>s+r.a,0),te=exp.reduce((s,r)=>s+r.a,0),pr=ti-te;
  document.getElementById('kpis').innerHTML=`
    <div class="bg-white dark:bg-gray-900 p-5 rounded-xl border border-gray-200 dark:border-gray-800 flex flex-col justify-between h-28 relative overflow-hidden group">
      <div class="text-[10px] uppercase font-bold text-gray-500 tracking-widest z-10">Total In</div>
      <div class="text-2xl font-bold text-gray-900 dark:text-white z-10 tracking-tight">${fK(ti)}</div>
      <div class="absolute -right-2 -bottom-4 text-8xl opacity-[0.03] group-hover:opacity-[0.06] transition-opacity pointer-events-none grayscale">üí∞</div>
    </div>
    <div class="bg-white dark:bg-gray-900 p-5 rounded-xl border border-gray-200 dark:border-gray-800 flex flex-col justify-between h-28 relative overflow-hidden group">
      <div class="text-[10px] uppercase font-bold text-gray-500 tracking-widest z-10">Total Out</div>
      <div class="text-2xl font-bold text-gray-900 dark:text-white z-10 tracking-tight">${fK(te)}</div>
      <div class="absolute -right-2 -bottom-4 text-8xl opacity-[0.03] group-hover:opacity-[0.06] transition-opacity pointer-events-none grayscale">üí∏</div>
    </div>
    <div class="bg-white dark:bg-gray-900 p-5 rounded-xl border border-gray-200 dark:border-gray-800 flex flex-col justify-between h-28">
      <div class="text-[10px] uppercase font-bold text-gray-500 tracking-widest">Net Profit</div>
      <div class="text-2xl font-bold ${pr>=0?'text-success-600':'text-danger-600'} tracking-tight">${fK(pr)}</div>
    </div>
    <div class="bg-white dark:bg-gray-900 p-5 rounded-xl border border-gray-200 dark:border-gray-800 flex flex-col justify-between h-28">
      <div class="text-[10px] uppercase font-bold text-gray-500 tracking-widest">Monthly Avg</div>
      <div class="text-2xl font-bold text-primary-600 tracking-tight">${fK(ti/gMC())}</div>
    </div>`;
    
  const icBC={};inc.forEach(r=>{const c=r.c||'Other';icBC[c]=(icBC[c]||0)+r.a});
  let sb=`<div class="text-xs font-bold text-gray-900 dark:text-white mb-3 uppercase tracking-wider flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-primary-500"></span> Income Breakdown</div>`;
  Object.entries(icBC).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{sb+=`<div class="flex justify-between text-xs py-2 border-b border-gray-100 dark:border-gray-800 last:border-0 items-center"><span class="text-gray-600 dark:text-gray-400">${esc(k)}</span><span class="font-mono font-bold text-gray-900 dark:text-gray-200">${fmt(v)}</span></div>`});
  document.getElementById('sBox').innerHTML=sb;
  
  rBar(inc,exp);rDonut(icBC,ti);rExpC(exp,te);genInsights(inc,exp);rInc();rExp();renderCatPage();
}

function rBar(inc,exp){
  const mo={};let st=new Date(s1),en=new Date(s2);
  while(st<=en){const m=st.toISOString().slice(0,7);mo[m]={i:0,e:0};st.setMonth(st.getMonth()+1)}
  inc.forEach(r=>{const m=r.d.slice(0,7);if(mo[m])mo[m].i+=r.a});
  exp.forEach(r=>{const m=r.d.slice(0,7);if(mo[m])mo[m].e+=r.a});
  const ks=Object.keys(mo).sort(),mx=Math.max(...ks.map(k=>Math.max(mo[k].i,mo[k].e)),1);
  document.getElementById('mChart').innerHTML=ks.map(k=>{
    const hi=Math.max(4,(mo[k].i/mx)*100),he=Math.max(4,(mo[k].e/mx)*100);
    return`<div class="flex-1 flex flex-col items-center justify-end h-full gap-1 group">
      <div class="w-full flex items-end gap-[2px] h-full px-1">
        <div class="flex-1 bg-primary-400 dark:bg-primary-600 rounded-t-[2px] opacity-80 group-hover:opacity-100 transition" style="height:${hi}%"></div>
        <div class="flex-1 bg-gray-300 dark:bg-gray-600 rounded-t-[2px] opacity-80 group-hover:opacity-100 transition" style="height:${he}%"></div>
      </div>
      <div class="text-[9px] text-gray-400 font-medium">${MH[+k.split('-')[1]-1]}</div>
    </div>`;
  }).join('');
}

function rDonut(cats,total){
  const ar=Object.entries(cats).sort((a,b)=>b[1]-a[1]);let deg=0,grad='';
  ar.forEach((c,i)=>{const p=total>0?c[1]/total*360:0;grad+=`${IC[i%IC.length]} ${deg}deg ${deg+p}deg,`;deg+=p});
  document.getElementById('donut').style.background=ar.length?`conic-gradient(${grad.slice(0,-1)})`:'#f4f4f5';
  document.getElementById('donut').innerHTML='<div class="absolute inset-[15%] bg-white dark:bg-gray-900 rounded-full flex items-center justify-center shadow-inner"><span class="text-[10px] text-gray-400 font-bold">Total</span></div>';
  document.getElementById('piLg').innerHTML=ar.map((c,i)=>{const p=total>0?(c[1]/total*100).toFixed(1):0;return `<div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full" style="background:${IC[i%IC.length]}"></div><div class="flex-1 flex justify-between text-[10px]"><span class="text-gray-600 dark:text-gray-300 font-medium truncate">${esc(c[0])}</span><span class="text-gray-400 font-mono">${p}%</span></div></div>`}).join('');
}

function rExpC(exp,total){
  const cats={};exp.forEach(r=>{const c=r.c||'Other';if(!cats[c])cats[c]={t:0,n:0};cats[c].t+=r.a;cats[c].n++});
  const ar=Object.entries(cats).sort((a,b)=>b[1].t-a[1].t),mx=ar[0]?ar[0][1].t:1;
  document.getElementById('eCats').innerHTML=ar.slice(0,10).map(([k,v],i)=>
    `<div class="mb-3 last:mb-0">
      <div class="flex justify-between text-xs mb-1.5 font-medium">
        <span class="text-gray-700 dark:text-gray-300">${esc(k)}</span>
        <span class="text-gray-900 dark:text-white font-mono">${fK(v.t)}</span>
      </div>
      <div class="h-1.5 w-full bg-gray-100 dark:bg-gray-800 rounded-full overflow-hidden">
        <div class="h-full rounded-full" style="width:${v.t/mx*100}%;background:${EC[i%EC.length]}"></div>
      </div>
    </div>`
  ).join('')||'<div class="text-center text-gray-400 text-xs py-4">No data available</div>';
}

function genInsights(inc,exp){
  let ins=[]; const ti=inc.reduce((s,r)=>s+r.a,0), te=exp.reduce((s,r)=>s+r.a,0), saving = ti-te;
  if(ti>0){const rate=((saving/ti)*100).toFixed(1);ins.push(rate>20?`üöÄ Strong saving rate of <b class="text-success-600">${rate}%</b>`:`üìâ Current saving rate: <b>${rate}%</b>`);}
  if(saving<0) ins.push(`<span class="text-danger-600">‚ö†Ô∏è Deficit Warning: <b>${fmt(Math.abs(saving))}</b> overspent</span>`);
  else ins.push(`‚úÖ Positive Cashflow: <b>${fmt(saving)}</b> saved.`);
  document.getElementById('insightsBox').innerHTML = ins.map(t=>`<div class="text-xs p-3 bg-primary-50 dark:bg-primary-900/10 rounded-lg border border-primary-100 dark:border-primary-900/20 text-gray-700 dark:text-gray-300 leading-relaxed">${t}</div>`).join('') || '<div class="text-center text-gray-400 text-xs">Gathering data...</div>';
}

function rInc(){
  const{inc}=gF();const cats=['◊î◊õ◊ú',...new Set(inc.map(r=>r.c).filter(Boolean))];
  document.getElementById('iCh').innerHTML=cats.map(c=>`<button class="px-3 py-1 rounded-md text-[10px] font-medium border transition ${iCt===c?'bg-gray-800 text-white border-gray-800 dark:bg-white dark:text-gray-900':'bg-white dark:bg-gray-900 text-gray-500 border-gray-200 dark:border-gray-700 hover:border-gray-400'}" data-cat="${encodeURIComponent(c)}">${esc(c)}</button>`).join('');
  const q=(document.getElementById('iSr').value||'').toLowerCase();
  const fl=inc.filter(r=>(iCt==='◊î◊õ◊ú'||r.c===iCt)&&(!q||r.desc.toLowerCase().includes(q)||r.c.toLowerCase().includes(q)));
  sumDash('sumI',fl,'text-success-600');document.getElementById('iCn').textContent=fl.length+' RECORDS FOUND';
  document.getElementById('iLs').innerHTML=fl.length?fl.map(r=>mkC(r,'i')).join(''):'<div class="text-center p-12 text-gray-300 dark:text-gray-600 text-sm">No records found</div>';
}

function rExp(){
  const{exp}=gF();const cats=['◊î◊õ◊ú',...[...new Set(exp.map(r=>r.c).filter(Boolean))].sort()];
  document.getElementById('eCh').innerHTML=cats.map(c=>`<button class="px-3 py-1 rounded-md text-[10px] font-medium border transition ${eCt===c?'bg-gray-800 text-white border-gray-800 dark:bg-white dark:text-gray-900':'bg-white dark:bg-gray-900 text-gray-500 border-gray-200 dark:border-gray-700 hover:border-gray-400'}" data-cat="${encodeURIComponent(c)}">${esc(c)}</button>`).join('');
  const q=(document.getElementById('eSr').value||'').toLowerCase();
  const fl=exp.filter(r=>(eCt==='◊î◊õ◊ú'||r.c===eCt)&&(!q||r.desc.toLowerCase().includes(q)||r.c.toLowerCase().includes(q)));
  sumDash('sumE',fl,'text-danger-600');document.getElementById('eCn').textContent=fl.length+' RECORDS FOUND';
  document.getElementById('eLs').innerHTML=fl.length?fl.map(r=>mkC(r,'e')).join(''):'<div class="text-center p-12 text-gray-300 dark:text-gray-600 text-sm">No records found</div>';
}

function go(p){curPg=p;
  ['S', 'I', 'E', 'T'].forEach((x,i)=>{
    const el = document.getElementById('pg'+x);
    if(x===p) { el.classList.remove('hidden'); window.scrollTo(0,0); }
    else el.classList.add('hidden');
    const btn = document.getElementById('n'+i);
    if(x===p) { btn.classList.add('text-primary-600','dark:text-primary-400'); btn.classList.remove('text-gray-400'); }
    else { btn.classList.remove('text-primary-600','dark:text-primary-400'); btn.classList.add('text-gray-400'); }
  });
}

document.addEventListener('click', function(e) {
  const delBtn = e.target.closest('.delete-cat-btn'); if (delBtn) { deleteCat(decodeURIComponent(delBtn.getAttribute('data-cat'))); return; }
  const editBtn = e.target.closest('.edit-cat-btn'); if (editBtn) { openEditCat(decodeURIComponent(editBtn.getAttribute('data-cat'))); return; }
  const iChBtn = e.target.closest('#iCh button'); if (iChBtn) { iCt = decodeURIComponent(iChBtn.getAttribute('data-cat')); rInc(); return; }
  const eChBtn = e.target.closest('#eCh button'); if (eChBtn) { eCt = decodeURIComponent(eChBtn.getAttribute('data-cat')); rExp(); return; }
});
</script>
</body>
</html>