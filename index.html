<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ShmoopsiePoo - Yael & Amit</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;800&display=swap');

:root {
  --bg-body:#0f172a;--bg-card:#1e293b;--bg-input:rgba(255,255,255,0.05);--border-color:rgba(255,255,255,0.1);
  --text-main:#f1f5f9;--text-sub:#94a3b8;--text-muted:#64748b;--accent:#14b8a6;
  --shadow:0 10px 25px rgba(0,0,0,0.5);--modal-bg:rgba(15,23,42,0.9);--nav-bg:rgba(15,23,42,0.95);
}
[data-theme="light"]{
  --bg-body:#f1f5f9;--bg-card:#ffffff;--bg-input:#e2e8f0;--border-color:#cbd5e1;
  --text-main:#0f172a;--text-sub:#475569;--text-muted:#94a3b8;--accent:#0d9488;
  --shadow:0 4px 15px rgba(0,0,0,0.1);--modal-bg:rgba(241,245,249,0.9);--nav-bg:rgba(255,255,255,0.95);
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg-body);color:var(--text-main);font-family:'Rubik',system-ui,sans-serif;direction:rtl;min-height:100vh;overflow-x:hidden;padding-bottom:90px;transition:background 0.3s,color 0.3s}
::-webkit-scrollbar{display:none}

/* ×”××“×‘×§×” ×©×œ×š */
#stickerOverlay {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  display: none; align-items: center; justify-content: center;
  z-index: 200000; pointer-events: none;
}
.sticker-img {
  width: 250px; height: 250px;
  animation: stickerPop 1.5s ease-out forwards;
}
@keyframes stickerPop {
  0% { transform: scale(0) rotate(-20deg); opacity: 0; }
  20% { transform: scale(1.2) rotate(10deg); opacity: 1; }
  80% { transform: scale(1.1) rotate(0deg); opacity: 1; }
  100% { transform: scale(0) rotate(20deg); opacity: 0; }
}

#bioLockScreen{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-body);z-index:100001;display:none;flex-direction:column;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(10px)}
#loginScreen{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-body);z-index:100000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.l-box{background:var(--bg-card);padding:40px 30px;border-radius:24px;width:100%;max-width:340px;text-align:center;box-shadow:var(--shadow);border:1px solid var(--border-color)}
.l-ttl{font-size:28px;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,#14b8a6,#f97316);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.l-btn{width:100%;padding:14px;background:white;color:#333;border:none;border-radius:10px;font-weight:700;font-size:15px;cursor:pointer;margin-top:6px;display:flex;align-items:center;justify-content:center;gap:10px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}

.hdr{background:linear-gradient(135deg,#134e4a,#0d9488,#134e4a);padding:16px;padding-top:calc(16px + env(safe-area-inset-top));position:sticky;top:0;z-index:50;box-shadow:0 2px 12px rgba(13,148,136,0.3)}
.hdr-r{display:flex;align-items:center;justify-content:space-between}
.lg{font-size:18px;font-weight:800;color:#fff}
.ref-btn{background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:8px;padding:4px 10px;font-size:14px;cursor:pointer}

.dba{background:var(--bg-card);padding:12px 14px;border-bottom:1px solid var(--border-color);display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.di{border:1px solid var(--border-color);border-radius:8px;padding:7px 10px;font-size:12px;outline:none;color:var(--text-main);background:var(--bg-input);flex:1;text-align:center}
.abtn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:7px 14px;font-size:12px;font-weight:600;cursor:pointer}

.ct{padding:12px}
.kg{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.kp{background:var(--bg-input);border-radius:12px;padding:12px 14px;flex:1 1 45%;border:1px solid var(--border-color)}
.kl{font-size:10px;color:var(--text-sub);margin-bottom:2px}
.kv{font-size:20px;font-weight:700}
.tl{color:var(--accent)}.or{color:#f97316}.gn{color:#34d399}

.cd{background:var(--bg-card);border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid var(--border-color)}
.ttt{font-size:12px;font-weight:600;margin-bottom:10px;color:var(--text-main)}

.bars{display:flex;align-items:flex-end;gap:3px;height:160px;padding:0 4px;border-bottom:1px solid var(--border-color)}
.bar-g{flex:1;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:flex-end}
.bar{border-radius:2px 2px 0 0;width:100%;max-width:14px}

.dc{background:var(--bg-card);border-radius:10px;padding:11px;margin-bottom:6px;border:1px solid var(--border-color)}
.dr{display:flex;justify-content:space-between;align-items:center}
.da{font-size:14px;font-weight:700}

.fab{position:fixed;bottom:90px;left:20px;width:56px;height:56px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:30px;box-shadow:0 4px 12px rgba(20,184,166,0.4);z-index:1000;border:none}
.fab.exp{background:#f97316;box-shadow:0 4px 12px rgba(249,115,22,0.4)}

.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--modal-bg);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)}
.modal.open{display:flex}
.m-box{background:var(--bg-card);width:100%;max-width:400px;border-radius:16px;padding:20px;border:1px solid var(--border-color)}
.inp{width:100%;padding:10px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:8px;color:var(--text-main);margin-bottom:12px;outline:none}

.nav{position:fixed;bottom:0;left:0;right:0;background:var(--nav-bg);backdrop-filter:blur(20px);border-top:1px solid var(--border-color);display:flex;justify-content:space-around;padding:8px 0;z-index:9999}
.nb{background:none;border:none;display:flex;flex-direction:column;align-items:center;cursor:pointer}
.nb.on{color:var(--accent)}.nb.off{color:var(--text-muted)}

.pg{display:none}.pg.show{display:block}
</style>
</head>
<body>

<div id="stickerOverlay"><img src="https://i.ibb.co/Xf8z1V4/shmoopsie-sticker.png" class="sticker-img"></div>

<div id="bioLockScreen">
  <div class="m-box" style="text-align:center;">
    <div style="font-size:60px;margin-bottom:20px;cursor:pointer;" onclick="unlockBio()">ğŸ‘¤</div>
    <div class="l-ttl">ShmoopsiePoo × ×¢×•×œ</div>
    <button class="abtn" onclick="unlockBio()" style="padding:10px 40px;">×¤×ª×— × ×¢×™×œ×”</button>
  </div>
</div>

<div id="loginScreen">
  <div class="l-box">
    <div class="l-ttl">ğŸ’° ShmoopsiePoo</div>
    <div class="l-sub">Yael & Amit</div>
    <button class="l-btn" onclick="doGoogleLogin()">×”×ª×—×‘×¨ ×¢× ×’×•×’×œ</button>
  </div>
</div>

<div id="mainApp" style="display:none">
  <div class="hdr">
    <div class="hdr-r">
      <div><div class="lg">ğŸ’° ShmoopsiePoo</div></div>
      <div>
        <button class="ref-btn" onclick="toggleTheme()">â˜€ï¸</button>
        <button class="ref-btn" onclick="firebase.auth().signOut()">ğŸšª</button>
      </div>
    </div>
  </div>

  <div class="dba">
    <input type="date" class="di" id="sd">
    <input type="date" class="di" id="ed">
    <button class="abtn" onclick="applyFilter()">×¡× ×Ÿ</button>
  </div>

  <div class="ct">
    <div id="pgS" class="pg show">
      <div class="kg" id="kpis"></div>
      <div class="cd"><div class="ttt">×”×›× ×¡×•×ª vs ×”×•×¦××•×ª</div><div id="mChart" class="bars"></div></div>
      <div id="sBox" class="sbox cd" style="text-align:center; padding:15px; font-weight:700;"></div>
    </div>

    <div id="pgI" class="pg">
      <div class="ttt">ğŸ’° ×¨×©×™××ª ×”×›× ×¡×•×ª</div>
      <div id="iLs"></div>
      <button class="fab" onclick="openModal('income')">+</button>
    </div>

    <div id="pgE" class="pg">
      <div class="ttt">ğŸ’¸ ×¨×©×™××ª ×”×•×¦××•×ª</div>
      <div id="eLs"></div>
      <button class="fab exp" onclick="openModal('expense')">ğŸ’¸</button>
    </div>

    <div id="pgT" class="pg">
      <div class="cd">
        <div class="ttt">ğŸ”’ ×”×’×“×¨×•×ª ××‘×˜×—×”</div>
        <button class="abtn" style="width:100%;" onclick="setupBio()">×”×¤×¢×œ/×‘×˜×œ × ×¢×™×œ×” ×‘×™×•××˜×¨×™×ª</button>
      </div>
    </div>
  </div>

  <div class="nav">
    <button class="nb on" id="n0" onclick="go('S')"><span class="ic">ğŸ“Š</span></button>
    <button class="nb off" id="n1" onclick="go('I')"><span class="ic">ğŸ’°</span></button>
    <button class="nb off" id="n2" onclick="go('E')"><span class="ic">ğŸ’¸</span></button>
    <button class="nb off" id="n3" onclick="go('T')"><span class="ic">âš™ï¸</span></button>
  </div>
</div>

<div class="modal" id="addModal">
  <div class="m-box">
    <div class="ttt" id="modalTitle">×”×•×¡×¤×”</div>
    <input type="number" class="inp" id="nAmt" placeholder="×¡×›×•×" inputmode="numeric">
    <input type="text" class="inp" id="nDesc" placeholder="×ª×™××•×¨">
    <button class="abtn" style="width:100%; padding:12px;" onclick="saveItem()">×©××•×¨</button>
    <button onclick="closeModal()" style="width:100%; background:none; border:none; color:var(--text-sub); margin-top:15px;">×‘×™×˜×•×œ</button>
  </div>
</div>

<script>
firebase.initializeApp({
  apiKey:"AIzaSyDX0XDsaB5_JEDH7chBGMVyeUeqPnpwVlE",
  authDomain:"shmoopsiepoo1202.firebaseapp.com",
  databaseURL:"https://shmoopsiepoo1202-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"shmoopsiepoo1202",
  storageBucket:"shmoopsiepoo1202.firebasestorage.app",
  messagingSenderId:"589285900622",
  appId:"1:589285900622:web:1ac7d9b5181266f20b1e1f"
});
const db=firebase.database(),dbRef=db.ref('shmoopsiepoo');
const ALLOWED_EMAILS = {'goreshnikamit@gmail.com': 'Amit', 'yael.example@gmail.com': 'Yael'};
const bioKeyName = 'shmoopsie_bio_enabled';
let currentUser='', s1='', s2='', curType='income';

function showSticker() {
  const o = document.getElementById('stickerOverlay');
  o.style.display = 'flex';
  setTimeout(() => { o.style.display = 'none'; }, 1500);
}

async function unlockBio() {
  if (!window.PublicKeyCredential) return;
  try {
    const challenge = new Uint8Array(32); window.crypto.getRandomValues(challenge);
    await navigator.credentials.get({publicKey: {challenge, timeout: 60000, userVerification: "required", allowCredentials: []}});
    document.getElementById('bioLockScreen').style.display = 'none';
  } catch (e) { console.error("Bio failed", e); }
}

function setupBio() {
  if (localStorage.getItem(bioKeyName)) { localStorage.removeItem(bioKeyName); alert("×‘×•×˜×œ"); }
  else { localStorage.setItem(bioKeyName, 'true'); alert("×”×•×¤×¢×œ!"); }
}

firebase.auth().onAuthStateChanged(user => {
  if (user && ALLOWED_EMAILS[user.email.toLowerCase()]) {
    currentUser = ALLOWED_EMAILS[user.email.toLowerCase()];
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    if (localStorage.getItem(bioKeyName)) { document.getElementById('bioLockScreen').style.display = 'flex'; unlockBio(); }
    startListening();
  } else {
    document.getElementById('loginScreen').style.display = 'flex';
    document.getElementById('mainApp').style.display = 'none';
  }
});

function doGoogleLogin() {
  const provider = new firebase.auth.GoogleAuthProvider();
  firebase.auth().signInWithPopup(provider).catch(() => firebase.auth().signInWithRedirect(provider));
}

function startListening() {
  const n = new Date(); s1 = n.toISOString().slice(0,7)+"-01"; s2 = n.toISOString().slice(0,10);
  document.getElementById('sd').value=s1; document.getElementById('ed').value=s2;
  dbRef.on('value', snap => { renderAll(snap.val() || {}); });
}

function saveItem() {
  const a = document.getElementById('nAmt').value, d = document.getElementById('nDesc').value;
  if(!a || !d) return;
  dbRef.child(curType).push({a: parseFloat(a), desc: d, d: new Date().toISOString().slice(0,10), by: currentUser});
  closeModal();
  if (curType === 'expense') showSticker();
  else if (typeof confetti==='function') confetti({particleCount:150, spread:70, origin:{y:0.6}});
}

function renderAll(v) {
  const inc = Object.values(v.income || {}).filter(r=>r.d>=s1&&r.d<=s2);
  const exp = Object.values(v.expense || {}).filter(r=>r.d>=s1&&r.d<=s2);
  const ti = inc.reduce((s,r)=>s+r.a,0), te = exp.reduce((s,r)=>s+r.a,0);
  
  document.getElementById('kpis').innerHTML = `
    <div class="kp"><div class="kl">×”×›× ×¡×•×ª</div><div class="kv tl">â‚ª${ti.toLocaleString()}</div></div>
    <div class="kp"><div class="kl">×”×•×¦××•×ª</div><div class="kv or">â‚ª${te.toLocaleString()}</div></div>`;
  document.getElementById('sBox').innerHTML = `×™×ª×¨×”: â‚ª${(ti-te).toLocaleString()}`;
  
  document.getElementById('iLs').innerHTML = inc.map(r=>`<div class="dc"><div class="dr"><div>${r.desc}</div><div class="da gn">+â‚ª${r.a}</div></div></div>`).join('');
  document.getElementById('eLs').innerHTML = exp.map(r=>`<div class="dc"><div class="dr"><div>${r.desc}</div><div class="da or">-â‚ª${r.a}</div></div></div>`).join('');
  
  const mx = Math.max(ti, te, 1);
  document.getElementById('mChart').innerHTML = `
    <div class="bar-g"><div class="bar" style="height:${(ti/mx)*100}%; background:#14b8a6;"></div><div style="font-size:10px;">×”×›× ×¡×•×ª</div></div>
    <div class="bar-g"><div class="bar" style="height:${(te/mx)*100}%; background:#f97316;"></div><div style="font-size:10px;">×”×•×¦××•×ª</div></div>`;
}

function applyFilter() { s1=document.getElementById('sd').value; s2=document.getElementById('ed').value; dbRef.once('value', s=>renderAll(s.val()||{})); }
function openModal(t) { curType=t; document.getElementById('modalTitle').textContent=t==='income'?'×”×›× ×¡×”':'×”×•×¦××”'; document.getElementById('addModal').classList.add('open'); }
function closeModal() { document.getElementById('addModal').classList.remove('open'); }
function go(p) { 
  ['S','I','E','T'].forEach((x,i)=>{
    document.getElementById('pg'+x).style.display=x===p?'block':'none';
    document.getElementById('n'+i).className='nb '+(x===p?'on':'off');
  });
}
function toggleTheme() { document.body.getAttribute('data-theme')==='light'?document.body.removeAttribute('data-theme'):document.body.setAttribute('data-theme','light'); }
</script>
</body>
</html>
