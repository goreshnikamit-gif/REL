<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>REL - ניהול אירועים</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700;800&display=swap');
:root {
    --bg-body: #0f172a; --bg-card: #1e293b; --accent: #14b8a6; --text-main: #f1f5f9; --text-sub: #94a3b8;
}
body { background: var(--bg-body); color: var(--text-main); font-family: 'Rubik', sans-serif; direction: rtl; margin: 0; padding-bottom: 80px; }
.hdr { background: linear-gradient(135deg, #134e4a, #0d9488); padding: 20px; text-align: center; color: white; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.hdr h1 { margin: 0; font-size: 22px; font-weight: 800; }
.ct { padding: 15px; }
.kg { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.kp { background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); text-align: center; }
.kl { font-size: 11px; color: var(--text-sub); margin-bottom: 5px; }
.kv { font-size: 18px; font-weight: 800; }
.gn { color: #34d399; } .tl { color: #14b8a6; } .or { color: #f97316; } .rd { color: #f87171; }
.cd { background: var(--bg-card); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1); }
.ttt { font-size: 14px; font-weight: 700; margin-bottom: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 5px; }
.row { display: flex; justify-content: space-between; padding: 8px 0; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); }
.row:last-child { border-bottom: none; }
.bars { display: flex; align-items: flex-end; gap: 5px; height: 150px; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
.bar-g { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; }
.bar { width: 100%; border-radius: 4px 4px 0 0; min-height: 2px; transition: height 0.3s; }
.bar-l { font-size: 9px; color: var(--text-sub); margin-top: 5px; }
.fab { position: fixed; bottom: 25px; left: 25px; width: 60px; height: 60px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 30px; border: none; box-shadow: 0 5px 15px rgba(20,184,166,0.4); cursor: pointer; z-index: 1000; }
.modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15,23,42,0.95); display: none; align-items: center; justify-content: center; padding: 20px; z-index: 2000; backdrop-filter: blur(5px); }
.m-box { background: var(--bg-card); width: 100%; max-width: 400px; border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
.inp { width: 100%; padding: 12px; margin-bottom: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; font-family: inherit; }
.btn-s { width: 100%; padding: 12px; background: var(--accent); border: none; border-radius: 8px; color: white; font-weight: 700; cursor: pointer; }
#loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 10000; display: flex; align-items: center; justify-content: center; flex-direction: column; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

<div id="loginScreen">
    <h1 style="margin-bottom:8px">REL</h1>
    <p style="color:var(--text-sub); margin-bottom:30px; font-size:14px">מערכת ניהול אירועים</p>
    <div id="g_id_onload" 
         data-client_id="943081015380-nhhrgi95qj8lhlt783ie62lvjfvau6cs.apps.googleusercontent.com" 
         data-callback="handleCredentialResponse"></div>
    <div class="g_id_signin" data-type="standard"></div>
</div>

<div id="mainApp" style="display:none">
    <div class="hdr"><h1>REL Dashboard</h1></div>
    <div class="ct">
        <div class="kg" id="topCards"></div>
        <div class="cd">
            <div class="ttt">רווח נקי שנתי (לפי חודשים)</div>
            <div id="profitChart" class="bars"></div>
        </div>
        <div id="monthlyBreakdown"></div>
    </div>
    <button class="fab" onclick="document.getElementById('addMod').style.display='flex'">+</button>
</div>

<div class="modal" id="addMod">
    <div class="m-box">
        <h3 style="text-align:center;margin-bottom:15px">הוספת אירוע חדש</h3>
        <input type="date" class="inp" id="eDate">
        <input type="text" class="inp" id="eArtist" placeholder="שם האמן / אירוע">
        <input type="text" class="inp" id="eDesc" placeholder="תיאור האירוע">
        <input type="text" class="inp" id="eLoc" placeholder="מיקום">
        <select class="inp" id="eVat">
            <option value="רגיל">מע"מ רגיל (17%)</option>
            <option value="פטור">פטור ממע"מ</option>
        </select>
        <input type="number" class="inp" id="eAmt" placeholder="סכום לפני מע״מ">
        <button class="btn-s" onclick="saveEvent()">שמור אירוע</button>
        <button onclick="document.getElementById('addMod').style.display='none'" style="width:100%;background:none;border:none;color:gray;margin-top:15px;font-size:13px">ביטול</button>
    </div>
</div>

<script>
// --- חיבורים אוטומטיים ---
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaISO7HN3efiEnT6TOG6EA4kH9pZbupL9851qLBttGU0CcCToiMhkJ2NCCSCWVpiQ7nQ/exec"; 
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPtRqvwEmfwI4ePjdlg0s8jYcLhCMyWNWWomaOPinnfGlP8-YoAg5RxR02_HXgXpK4rdPqOQmxEm3I/pub?gid=1566301765&single=true&output=csv";

async function handleCredentialResponse(response) {
    const payload = JSON.parse(atob(response.credential.split('.')[1]));
    const userEmail = payload.email;

    try {
        const res = await fetch(SCRIPT_URL, { 
            method: 'POST', 
            body: JSON.stringify({ action: "checkAuth", email: userEmail }) 
        });
        const auth = await res.text();
        
        if (auth.trim() === "authorized") {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            loadData();
        } else {
            alert("גישה נדחתה. המייל " + userEmail + " אינו מורשה בקובץ זה.");
        }
    } catch (e) {
        alert("שגיאת התחברות. וודא שביצעת Deploy ל-Anyone ב-Apps Script.");
    }
}

async function loadData() {
    try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        const rows = text.split('\n').map(r => r.split(',')).filter(r => r[0] && r[0] !== 'חודש');
        
        const parseNum = (val) => {
            if(!val) return 0;
            return parseFloat(val.replace(/[₪,%\s]/g, "")) || 0;
        };

        const validRows = rows.filter(r => parseNum(r[1]) > 0 || parseNum(r[7]) !== 0);
        const current = validRows[validRows.length - 1];
        
        if (current) {
            document.getElementById('topCards').innerHTML = `
                <div class="kp"><div class="kl">הכנסות החודש</div><div class="kv gn">₪${parseNum(current[1]).toLocaleString()}</div></div>
                <div class="kp"><div class="kl">רווח נקי</div><div class="kv tl">₪${parseNum(current[7]).toLocaleString()}</div></div>
            `;
            
            let html = '<div class="cd"><div class="ttt">פירוט חודשי - ' + current[0] + '</div>';
            const labels = ["הכנסות מאירועים", "הוצאות אירועים", "רווח גולמי", "הוצאות משרד", "משכורות עובדים", "מסים", "רווח נקי"];
            labels.forEach((l, i) => {
                const val = current[i+1] || "₪0";
                html += `<div class="row"><span>${l}</span><span style="font-weight:700">${val}</span></div>`;
            });
            document.getElementById('monthlyBreakdown').innerHTML = html + '</div>';
        }

        const maxProfit = Math.max(...rows.map(r => Math.abs(parseNum(r[7]))), 1);
        let chartHtml = '';
        rows.forEach(r => {
            const val = parseNum(r[7]);
            const height = (Math.abs(val) / maxProfit) * 120;
            const color = val >= 0 ? '#34d399' : '#f87171';
            chartHtml += `
                <div class="bar-g">
                    <div class="bar" style="height:${height}px; background:${color}"></div>
                    <div class="bar-l">${r[0].slice(0,3)}</div>
                </div>`;
        });
        document.getElementById('profitChart').innerHTML = chartHtml;

    } catch (e) {
        console.error("Error loading CSV data", e);
    }
}

async function saveEvent() {
    const data = {
        type: 'event',
        date: document.getElementById('eDate').value,
        artist: document.getElementById('eArtist').value,
        description: document.getElementById('eDesc').value,
        location: document.getElementById('eLoc').value,
        vatType: document.getElementById('eVat').value,
        amountBefore: document.getElementById('eAmt').value
    };
    
    if(!data.date || !data.amountBefore) { alert('חובה למלא תאריך וסכום'); return; }

    const btn = document.querySelector('.btn-s');
    btn.disabled = true; btn.innerText = 'שומר...';
    
    try {
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        alert('האירוע נשמר בהצלחה בגיליון החודש המתאים!');
        location.reload();
    } catch(e) { 
        alert('שגיאה בשמירה'); 
        btn.disabled = false; btn.innerText = 'שמור אירוע'; 
    }
}
</script>
</body>
</html>
