<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ShmoopsiePoo</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;800&display=swap');

* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Rubik', sans-serif;
  background: #0f172a;
  color: #f1f5f9;
  direction: rtl;
  min-height: 100vh;
}

.container { max-width: 1200px; margin: 0 auto; padding: 20px; }

header {
  background: linear-gradient(135deg, #10b981, #059669);
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
  text-align: center;
  color: white;
}

header h1 { font-size: 28px; margin-bottom: 5px; }

.login-box {
  max-width: 400px;
  margin: 80px auto;
  background: #1e293b;
  padding: 40px;
  border-radius: 12px;
  border: 1px solid #334155;
}

.login-box h2 {
  text-align: center;
  margin-bottom: 30px;
  font-size: 24px;
  background: linear-gradient(135deg, #10b981, #3b82f6);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.login-error {
  color: #ef4444;
  text-align: center;
  margin-bottom: 10px;
  font-size: 13px;
  display: none;
}

input, select {
  width: 100%;
  padding: 12px;
  margin-bottom: 12px;
  background: #0f172a;
  border: 1px solid #334155;
  color: #f1f5f9;
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  -webkit-appearance: none;
  appearance: none;
}

input:focus, select:focus {
  outline: none;
  border-color: #10b981;
}

button {
  width: 100%;
  padding: 12px;
  background: #10b981;
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  cursor: pointer;
  font-family: inherit;
  font-size: 14px;
  transition: background 0.2s;
}

button:hover { background: #059669; }
button:active { transform: scale(0.98); }

#app { display: none; }

.header-bar {
  background: #1e293b;
  padding: 15px;
  border-radius: 12px;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.user-info { font-size: 12px; color: #94a3b8; }
.user-info strong { color: #10b981; }

.sync-status {
  font-size: 11px;
  color: #10b981;
  display: inline-flex;
  align-items: center;
  gap: 5px;
}

.sync-dot {
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.top-buttons {
  display: flex;
  gap: 10px;
}

.top-buttons button {
  padding: 8px 12px;
  font-size: 12px;
  width: auto;
  background: #334155;
}

.top-buttons button:hover { background: #475569; }

.section {
  background: #1e293b;
  padding: 20px;
  border-radius: 12px;
  margin-bottom: 20px;
}

.section h3 {
  font-size: 16px;
  margin-bottom: 15px;
  color: #10b981;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}

.stat-card {
  background: #0f172a;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  border: 1px solid #334155;
}

.stat-label {
  font-size: 11px;
  color: #94a3b8;
  margin-bottom: 5px;
}

.stat-value {
  font-size: 20px;
  font-weight: 700;
  color: #10b981;
}

.stat-value.expense { color: #ef4444; }

.input-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 10px;
  margin-bottom: 15px;
}

/* Custom category chips */
.cat-selector {
  margin-bottom: 12px;
}

.cat-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 8px;
}

.cat-chip {
  padding: 8px 14px;
  background: #0f172a;
  border: 1px solid #334155;
  border-radius: 20px;
  font-size: 13px;
  color: #94a3b8;
  cursor: pointer;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  width: auto;
}

.cat-chip:hover { border-color: #10b981; color: #f1f5f9; background: #1e293b; }

.cat-chip.selected {
  background: #10b981;
  border-color: #10b981;
  color: white;
}

.cat-chip .remove-cat {
  font-size: 14px;
  opacity: 0.6;
  cursor: pointer;
  margin-right: 2px;
}

.cat-chip .remove-cat:hover { opacity: 1; }

.add-cat-row {
  display: flex;
  gap: 8px;
}

.add-cat-row input {
  flex: 1;
  margin-bottom: 0;
  font-size: 13px;
  padding: 8px 12px;
}

.add-cat-row button {
  width: auto;
  padding: 8px 16px;
  font-size: 13px;
}

.item {
  background: #0f172a;
  padding: 12px;
  border-radius: 8px;
  margin-bottom: 8px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 1px solid #334155;
  animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-5px); }
  to { opacity: 1; transform: translateY(0); }
}

.item-left { flex: 1; }
.item-title { font-weight: 600; font-size: 14px; margin-bottom: 4px; }
.item-meta { font-size: 11px; color: #94a3b8; }
.item-amount { font-weight: 700; font-size: 14px; white-space: nowrap; }
.item-amount.income { color: #10b981; }
.item-amount.expense { color: #ef4444; }

.item-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

.delete-btn {
  background: #ef4444;
  padding: 6px 10px;
  font-size: 12px;
  width: auto;
}

.delete-btn:hover { background: #dc2626; }

.tabs {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
}

.tab-btn {
  padding: 10px 20px;
  background: #334155;
  border: none;
  border-radius: 8px;
  color: #94a3b8;
  cursor: pointer;
  font-family: inherit;
  font-weight: 600;
  width: auto;
  transition: all 0.2s;
}

.tab-btn.active {
  background: #10b981;
  color: white;
}

.tab-content { display: none; }
.tab-content.active { display: block; }

.month-filter {
  display: flex;
  gap: 10px;
  align-items: center;
  flex-wrap: wrap;
}

.month-filter label {
  font-size: 13px;
  color: #94a3b8;
}

.month-filter input[type="month"] {
  width: auto;
  margin-bottom: 0;
}

.empty-state {
  text-align: center;
  padding: 30px;
  color: #64748b;
  font-size: 14px;
}

.footer {
  text-align: center;
  padding: 20px;
  color: #64748b;
  font-size: 12px;
}
</style>
</head>
<body>

<div id="login">
  <div class="login-box">
    <h2>ğŸ’° ShmoopsiePoo</h2>
    <div class="login-error" id="loginError"></div>
    <input type="text" id="name" placeholder="×©× (Amit ××• Yael)" autocomplete="username">
    <input type="password" id="pass" placeholder="×¡×™×¡××”" autocomplete="current-password">
    <button onclick="doAuth()">×”×ª×—×‘×¨</button>
  </div>
</div>

<div id="app">
  <div class="container">
    <header>
      <h1>ğŸ’° ShmoopsiePoo</h1>
      <p>Yael & Amit</p>
    </header>

    <div class="header-bar">
      <div>
        <div class="user-info">××—×•×‘×¨: <strong id="userName"></strong></div>
        <div class="sync-status"><span class="sync-dot"></span> ××¡×•× ×›×¨×Ÿ ×‘×–××Ÿ ×××ª</div>
      </div>
      <div class="top-buttons">
        <button onclick="exportCSV()">ğŸ“¥ ×™×™×¦×•×</button>
        <button onclick="logout()">ğŸšª ×”×ª× ×ª×§</button>
      </div>
    </div>

    <div class="section" style="padding: 12px 20px;">
      <div class="month-filter">
        <label>×¡×™× ×•×Ÿ ×œ×¤×™ ×—×•×“×©:</label>
        <input type="month" id="filterMonth" onchange="render()">
        <button style="width:auto; padding:8px 16px; background:#334155;" onclick="document.getElementById('filterMonth').value=''; render();">×”×›×œ</button>
      </div>
    </div>

    <div class="section">
      <h3>ğŸ“Š ×¡×™×›×•×</h3>
      <div class="grid">
        <div class="stat-card">
          <div class="stat-label">×¡×”"×› ×”×›× ×¡×•×ª</div>
          <div class="stat-value" id="totalIncome">â‚ª0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">×¡×”"×› ×”×•×¦××•×ª</div>
          <div class="stat-value expense" id="totalExpense">â‚ª0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">×™×ª×¨×”</div>
          <div class="stat-value" id="balance">â‚ª0</div>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('income')">ğŸ’š ×”×›× ×¡×•×ª</button>
      <button class="tab-btn" onclick="switchTab('expense')">â¤ï¸ ×”×•×¦××•×ª</button>
    </div>

    <div id="income" class="tab-content active">
      <div class="section">
        <h3>×”×•×¡×£ ×”×›× ×¡×”</h3>
        <div class="input-group">
          <input type="date" id="incDate">
          <input type="number" id="incAmount" placeholder="×¡×›×•×" inputmode="numeric">
          <input type="text" id="incDesc" placeholder="×ª×™××•×¨">
        </div>
        <div class="cat-selector">
          <div class="cat-chips" id="incCatChips"></div>
          <div class="add-cat-row">
            <input type="text" id="newIncCat" placeholder="×§×˜×’×•×¨×™×” ×—×“×©×”...">
            <button onclick="addCategory('income')">+</button>
          </div>
        </div>
        <button onclick="addItem('income')">â• ×”×•×¡×£ ×”×›× ×¡×”</button>
        <div id="incomeList" style="margin-top:15px"></div>
      </div>
    </div>

    <div id="expense" class="tab-content">
      <div class="section">
        <h3>×”×•×¡×£ ×”×•×¦××”</h3>
        <div class="input-group">
          <input type="date" id="expDate">
          <input type="number" id="expAmount" placeholder="×¡×›×•×" inputmode="numeric">
          <input type="text" id="expDesc" placeholder="×ª×™××•×¨">
        </div>
        <div class="cat-selector">
          <div class="cat-chips" id="expCatChips"></div>
          <div class="add-cat-row">
            <input type="text" id="newExpCat" placeholder="×§×˜×’×•×¨×™×” ×—×“×©×”...">
            <button onclick="addCategory('expense')">+</button>
          </div>
        </div>
        <button onclick="addItem('expense')">â• ×”×•×¡×£ ×”×•×¦××”</button>
        <div id="expenseList" style="margin-top:15px"></div>
      </div>
    </div>

    <div class="footer">×¢×•×“×›×Ÿ: <span id="lastUpdate"></span></div>
  </div>
</div>

<script>
// ========== FIREBASE INIT ==========
const firebaseConfig = {
  apiKey: "AIzaSyDX0XDsaB5_JEDH7chBGMVyeUeqPnpwVlE",
  authDomain: "shmoopsiepoo1202.firebaseapp.com",
  databaseURL: "https://shmoopsiepoo1202-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "shmoopsiepoo1202",
  storageBucket: "shmoopsiepoo1202.firebasestorage.app",
  messagingSenderId: "589285900622",
  appId: "1:589285900622:web:1ac7d9b5181266f20b1e1f",
  measurementId: "G-63NHSQ3536"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const dbRef = db.ref('shmoopsiepoo');

// ========== STATE ==========
const USERS = { 'Amit': '1710', 'Yael': '1202' };
let currentUser = '';
let data = { income: [], expense: [], categories: { income: [], expense: [] } };
let selectedCat = { income: '', expense: '' };

// ========== AUTH ==========
function doAuth() {
  const name = document.getElementById('name').value.trim();
  const pass = document.getElementById('pass').value.trim();
  const errorEl = document.getElementById('loginError');

  if (!name || !pass) {
    errorEl.textContent = '×× × ×”×›× ×¡ ×©× ×•×¡×™×¡××”';
    errorEl.style.display = 'block';
    return;
  }

  if (USERS[name] && USERS[name] === pass) {
    currentUser = name;
    localStorage.setItem('shmoopsiepoo_user', name);
    errorEl.style.display = 'none';
    showApp();
  } else {
    errorEl.textContent = '×©× ××• ×¡×™×¡××” ×©×’×•×™×™×';
    errorEl.style.display = 'block';
  }
}

document.addEventListener('keydown', function(e) {
  if (e.key === 'Enter' && document.getElementById('login').style.display !== 'none') {
    doAuth();
  }
});

function showApp() {
  document.getElementById('login').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('userName').textContent = currentUser;
  setToday();
  startListening();
}

function logout() {
  localStorage.removeItem('shmoopsiepoo_user');
  dbRef.off();
  currentUser = '';
  location.reload();
}

function setToday() {
  const d = new Date().toISOString().split('T')[0];
  document.getElementById('incDate').value = d;
  document.getElementById('expDate').value = d;
}

// ========== FIREBASE REALTIME ==========
function startListening() {
  dbRef.on('value', function(snapshot) {
    const val = snapshot.val();
    if (val) {
      data.income = val.income ? Object.values(val.income) : [];
      data.expense = val.expense ? Object.values(val.expense) : [];
      data.categories = val.categories || { income: [], expense: [] };
      if (!Array.isArray(data.categories.income)) data.categories.income = Object.values(data.categories.income || {});
      if (!Array.isArray(data.categories.expense)) data.categories.expense = Object.values(data.categories.expense || {});
    } else {
      data = { income: [], expense: [], categories: { income: [], expense: [] } };
    }
    renderCategories();
    render();
  });
}

// ========== CATEGORIES ==========
function addCategory(type) {
  const inputId = type === 'income' ? 'newIncCat' : 'newExpCat';
  const val = document.getElementById(inputId).value.trim();
  if (!val) return;

  const cats = data.categories[type] || [];
  if (cats.includes(val)) {
    alert('×§×˜×’×•×¨×™×” ×›×‘×¨ ×§×™×™××ª');
    return;
  }

  cats.push(val);
  dbRef.child('categories').child(type).set(cats);
  document.getElementById(inputId).value = '';
  selectedCat[type] = val;
}

function removeCategory(type, cat) {
  if (!confirm('×œ××—×•×§ ×§×˜×’×•×¨×™×” "' + cat + '"?')) return;
  const cats = (data.categories[type] || []).filter(c => c !== cat);
  dbRef.child('categories').child(type).set(cats);
  if (selectedCat[type] === cat) selectedCat[type] = '';
}

function selectCat(type, cat) {
  selectedCat[type] = selectedCat[type] === cat ? '' : cat;
  renderCategories();
}

function renderCategories() {
  ['income', 'expense'].forEach(type => {
    const containerId = type === 'income' ? 'incCatChips' : 'expCatChips';
    const cats = data.categories[type] || [];
    document.getElementById(containerId).innerHTML = cats.map(cat => `
      <div class="cat-chip ${selectedCat[type] === cat ? 'selected' : ''}" onclick="selectCat('${type}','${esc(cat)}')">
        ${esc(cat)}
        <span class="remove-cat" onclick="event.stopPropagation(); removeCategory('${type}','${esc(cat)}')">âœ•</span>
      </div>
    `).join('');
  });
}

// ========== ADD / DELETE ==========
function addItem(type) {
  const prefix = type === 'income' ? 'inc' : 'exp';
  const d = document.getElementById(prefix + 'Date').value;
  const a = parseFloat(document.getElementById(prefix + 'Amount').value);
  const desc = document.getElementById(prefix + 'Desc').value.trim();
  const c = selectedCat[type];

  if (!d || !a || a <= 0 || !desc) {
    alert('××œ× ××ª ×›×œ ×”×©×“×•×ª');
    return;
  }

  if (!c) {
    alert('×‘×—×¨ ×§×˜×’×•×¨×™×”');
    return;
  }

  const id = Date.now().toString();
  dbRef.child(type).child(id).set({ d, a, desc, c, id, by: currentUser });

  document.getElementById(prefix + 'Amount').value = '';
  document.getElementById(prefix + 'Desc').value = '';
  selectedCat[type] = '';
  renderCategories();

  if (type === 'income' && typeof confetti === 'function') {
    confetti({ particleCount: 100, spread: 60, origin: { y: 0.7 } });
  }
}

function deleteItem(type, id) {
  if (!confirm('×œ××—×•×§?')) return;
  dbRef.child(type).child(id).remove();
}

// ========== RENDER ==========
function render() {
  const filterMonth = document.getElementById('filterMonth').value;

  let incomes = data.income || [];
  let expenses = data.expense || [];

  if (filterMonth) {
    incomes = incomes.filter(x => x.d && x.d.startsWith(filterMonth));
    expenses = expenses.filter(x => x.d && x.d.startsWith(filterMonth));
  }

  incomes.sort((a, b) => (b.d || '').localeCompare(a.d || ''));
  expenses.sort((a, b) => (b.d || '').localeCompare(a.d || ''));

  const ti = incomes.reduce((s, x) => s + (x.a || 0), 0);
  const te = expenses.reduce((s, x) => s + (x.a || 0), 0);
  const bal = ti - te;

  document.getElementById('totalIncome').textContent = 'â‚ª' + ti.toLocaleString('he-IL');
  document.getElementById('totalExpense').textContent = 'â‚ª' + te.toLocaleString('he-IL');

  const balEl = document.getElementById('balance');
  balEl.textContent = 'â‚ª' + bal.toLocaleString('he-IL');
  balEl.className = 'stat-value' + (bal < 0 ? ' expense' : '');

  document.getElementById('incomeList').innerHTML = incomes.length === 0
    ? '<div class="empty-state">××™×Ÿ ×”×›× ×¡×•×ª ×œ×”×¦×’×”</div>'
    : incomes.map(x => `
      <div class="item">
        <div class="item-left">
          <div class="item-title">${esc(x.desc)}</div>
          <div class="item-meta">${x.d} â€¢ ${esc(x.c)}${x.by ? ' â€¢ ' + esc(x.by) : ''}</div>
        </div>
        <div class="item-actions">
          <div class="item-amount income">+â‚ª${(x.a || 0).toLocaleString('he-IL')}</div>
          <button class="delete-btn" onclick="deleteItem('income','${x.id}')">ğŸ—‘</button>
        </div>
      </div>
    `).join('');

  document.getElementById('expenseList').innerHTML = expenses.length === 0
    ? '<div class="empty-state">××™×Ÿ ×”×•×¦××•×ª ×œ×”×¦×’×”</div>'
    : expenses.map(x => `
      <div class="item">
        <div class="item-left">
          <div class="item-title">${esc(x.desc)}</div>
          <div class="item-meta">${x.d} â€¢ ${esc(x.c)}${x.by ? ' â€¢ ' + esc(x.by) : ''}</div>
        </div>
        <div class="item-actions">
          <div class="item-amount expense">-â‚ª${(x.a || 0).toLocaleString('he-IL')}</div>
          <button class="delete-btn" onclick="deleteItem('expense','${x.id}')">ğŸ—‘</button>
        </div>
      </div>
    `).join('');

  document.getElementById('lastUpdate').textContent = new Date().toLocaleString('he-IL');
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s || '';
  return d.innerHTML;
}

// ========== TABS ==========
function switchTab(t) {
  document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
  document.getElementById(t).classList.add('active');
  document.querySelector(`[onclick="switchTab('${t}')"]`).classList.add('active');
}

// ========== EXPORT ==========
function exportCSV() {
  const lines = ['×¡×•×’,×ª××¨×™×š,×ª×™××•×¨,×§×˜×’×•×¨×™×”,×¡×›×•×,× ×•×¡×£ ×¢"×™'];
  (data.income || []).forEach(x => lines.push(`×”×›× ×¡×”,${x.d},${x.desc},${x.c},${x.a},${x.by || ''}`));
  (data.expense || []).forEach(x => lines.push(`×”×•×¦××”,${x.d},${x.desc},${x.c},${x.a},${x.by || ''}`));

  const blob = new Blob(['\ufeff' + lines.join('\n')], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'shmoopsiepoo_' + new Date().toISOString().slice(0, 10) + '.csv';
  a.click();
  URL.revokeObjectURL(url);
}

// ========== AUTO LOGIN ==========
(function() {
  const saved = localStorage.getItem('shmoopsiepoo_user');
  if (saved && USERS[saved]) {
    currentUser = saved;
    showApp();
  }
})();
</script>

</body>
</html>
