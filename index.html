<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<title>ShmoopsiePoo - Yael & Amit</title>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;800&display=swap');

:root {
  --bg-body:#0f172a;--bg-card:#1e293b;--bg-input:rgba(255,255,255,0.05);--border-color:rgba(255,255,255,0.1);
  --text-main:#f1f5f9;--text-sub:#94a3b8;--text-muted:#64748b;--accent:#14b8a6;
  --shadow:0 10px 25px rgba(0,0,0,0.5);--modal-bg:rgba(15,23,42,0.9);--nav-bg:rgba(15,23,42,0.95);
}
[data-theme="light"]{
  --bg-body:#f1f5f9;--bg-card:#ffffff;--bg-input:#e2e8f0;--border-color:#cbd5e1;
  --text-main:#0f172a;--text-sub:#475569;--text-muted:#94a3b8;--accent:#0d9488;
  --shadow:0 4px 15px rgba(0,0,0,0.1);--modal-bg:rgba(241,245,249,0.9);--nav-bg:rgba(255,255,255,0.95);
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg-body);color:var(--text-main);font-family:'Rubik',system-ui,sans-serif;direction:rtl;min-height:100vh;overflow-x:hidden;padding-bottom:90px;transition:background 0.3s,color 0.3s}
::-webkit-scrollbar{display:none}

/* LOGIN */
#loginScreen{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-body);z-index:100000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.l-box{background:var(--bg-card);padding:40px 30px;border-radius:24px;width:100%;max-width:340px;text-align:center;box-shadow:var(--shadow);border:1px solid var(--border-color)}
.l-ttl{font-size:28px;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg,#14b8a6,#f97316);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.l-sub{font-size:14px;color:var(--text-sub);margin-bottom:24px}
.l-inp{width:100%;padding:12px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:10px;color:var(--text-main);font-family:inherit;font-size:14px;outline:none;margin-bottom:10px;text-align:center}
.l-inp:focus{border-color:var(--accent)}
.l-btn{width:100%;padding:14px;background:var(--accent);color:white;border:none;border-radius:10px;font-weight:700;font-size:15px;font-family:inherit;cursor:pointer;margin-top:6px}
.l-err{color:#f87171;font-size:12px;margin-bottom:8px;display:none}

/* HEADER */
.hdr{background:linear-gradient(135deg,#134e4a,#0d9488,#134e4a);padding:16px;padding-top:calc(16px + env(safe-area-inset-top));position:sticky;top:0;z-index:50;box-shadow:0 2px 12px rgba(13,148,136,0.3)}
.hdr-r{display:flex;align-items:center;justify-content:space-between}
.lg{font-size:18px;font-weight:800;color:#fff}
.lg-s{font-size:10px;color:rgba(255,255,255,0.8)}
.ref-btn{background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:8px;padding:4px 10px;font-size:14px;font-family:inherit;cursor:pointer;margin-right:5px}
.plb{color:rgba(255,255,255,0.9);font-size:11px;font-weight:500}

/* DATE BAR */
.dba{background:var(--bg-card);padding:12px 14px;border-bottom:1px solid var(--border-color);display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.dba label{font-size:11px;color:var(--text-sub);font-weight:500}
.di{border:1px solid var(--border-color);border-radius:8px;padding:7px 10px;font-size:12px;font-family:inherit;outline:none;color:var(--text-main);background:var(--bg-input);flex:1;min-width:100px;text-align:center}
.abtn{background:var(--accent);color:#fff;border:none;border-radius:8px;padding:7px 14px;font-size:12px;font-weight:600;font-family:inherit;cursor:pointer}
.prw{display:flex;gap:5px;width:100%;margin-top:4px;overflow-x:auto;padding-bottom:2px}
.pb{padding:4px 9px;border-radius:14px;border:1px solid var(--border-color);font-size:10px;font-family:inherit;cursor:pointer;background:var(--bg-input);color:var(--text-sub);white-space:nowrap}
.pb.on{background:var(--accent);color:#fff;border-color:var(--accent)}

/* CONTENT */
.ct{padding:12px}
.kg{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.kp{background:var(--bg-input);border-radius:12px;padding:12px 14px;flex:1 1 45%;min-width:135px;border:1px solid var(--border-color)}
.kl{font-size:10px;color:var(--text-sub);margin-bottom:2px;font-weight:500}
.kv{font-size:20px;font-weight:700;letter-spacing:-0.02em}
.tl{color:var(--accent)}.or{color:#f97316}.bl{color:#3b82f6}.rd{color:#f87171}.gn{color:#34d399}

.cd{background:var(--bg-card);border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid var(--border-color)}
.ttt{font-size:12px;font-weight:600;margin-bottom:10px;color:var(--text-main)}

.sbox{background:linear-gradient(135deg,rgba(13,148,136,0.1),rgba(16,185,129,0.08));border:1px solid rgba(13,148,136,0.3);border-radius:12px;padding:14px;margin-bottom:12px}
.sbt{font-size:12px;font-weight:600;color:var(--accent);margin-bottom:6px}
.sr{display:flex;justify-content:space-between;padding:3px 0;font-size:12px}

.bars{display:flex;align-items:flex-end;gap:3px;height:160px;padding:0 4px;border-bottom:1px solid var(--border-color)}
.bar-g{flex:1;display:flex;flex-direction:column;align-items:center;gap:1px;height:100%;justify-content:flex-end;min-width:0}
.bar{border-radius:2px 2px 0 0;min-height:1px;width:100%;max-width:14px}
.bar-l{font-size:7px;color:var(--text-muted);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:100%;text-align:center}

.donut{width:140px;height:140px;border-radius:50%;position:relative}
.donut::after{content:'';position:absolute;top:25%;left:25%;width:50%;height:50%;border-radius:50%;background:var(--bg-card)}
.donut-w{display:flex;align-items:center;gap:10px}
.dlg{display:flex;align-items:center;gap:5px;margin-bottom:5px}
.ddot{width:8px;height:8px;border-radius:2px;flex-shrink:0}

.cr{margin-bottom:8px}
.crh{display:flex;justify-content:space-between;margin-bottom:2px}
.crn{font-size:11px;font-weight:500;color:var(--text-main)}
.crv{font-size:11px;font-weight:600}
.crt{height:4px;background:var(--bg-input);border-radius:2px;overflow:hidden}
.crf{height:100%;border-radius:2px}
.crs{font-size:9px;color:var(--text-muted);display:flex;justify-content:space-between;margin-top:1px}

/* ITEMS */
.dc{background:var(--bg-card);border-radius:10px;padding:9px 11px;margin-bottom:5px;border:1px solid var(--border-color)}
.dr{display:flex;justify-content:space-between;align-items:flex-start}
.dtt{font-size:11px;font-weight:500;color:var(--text-main);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.dm{font-size:9px;color:var(--text-muted);margin-top:2px;display:flex;gap:5px;align-items:center}
.dbg{padding:1px 6px;border-radius:10px;font-size:8px;font-weight:500;color:#fff}
.da{font-size:13px;font-weight:700;margin-right:8px;white-space:nowrap}
.del-btn{background:none;border:none;color:#f87171;font-size:14px;cursor:pointer;padding:2px 6px;opacity:0.6}
.del-btn:hover{opacity:1}

.summary-dash{display:flex;justify-content:space-between;background:var(--bg-card);padding:12px;border-radius:12px;margin-bottom:12px;border:1px solid var(--border-color);text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.summary-dash>div{flex:1}
.sd-ttl{font-size:11px;color:var(--text-sub);margin-bottom:4px;font-weight:500}
.sd-val{font-size:16px;font-weight:800;color:var(--text-main)}

.si{width:100%;padding:9px 12px;border-radius:9px;border:1px solid var(--border-color);background:var(--bg-input);color:var(--text-main);font-size:12px;font-family:inherit;outline:none;margin-bottom:6px}
.fr{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:8px}
.fp{padding:3px 8px;border-radius:14px;border:1px solid var(--border-color);font-size:9px;font-family:inherit;cursor:pointer;background:var(--bg-input);color:var(--text-sub)}
.fp.on{background:var(--accent);color:#fff;border-color:var(--accent)}
.cn{font-size:10px;color:var(--text-muted);margin-bottom:6px}

.tabs{display:flex;background:var(--bg-input);border-radius:10px;padding:3px;margin-bottom:12px}
.tab{flex:1;padding:8px 0;border-radius:8px;border:none;font-size:11px;font-weight:600;font-family:inherit;cursor:pointer;background:transparent;color:var(--text-muted)}
.tab.on{background:rgba(255,255,255,0.1);color:var(--accent)}
[data-theme="light"] .tab.on{background:#fff;box-shadow:0 2px 5px rgba(0,0,0,0.05)}

.insight-item{font-size:13px;margin-bottom:8px;padding:10px 12px;background:var(--bg-input);border-radius:8px;border-right:4px solid var(--accent);line-height:1.4}

/* FAB */
.fab{position:fixed;bottom:90px;left:20px;width:56px;height:56px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:30px;box-shadow:0 4px 12px rgba(20,184,166,0.4);z-index:1000;border:none;cursor:pointer;transition:transform 0.2s}
.fab.exp{background:#f97316;box-shadow:0 4px 12px rgba(249,115,22,0.4)}
.fab:active{transform:scale(0.95)}

/* MODAL */
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--modal-bg);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)}
.modal.open{display:flex}
.m-box{background:var(--bg-card);width:100%;max-width:400px;border-radius:16px;padding:20px;border:1px solid var(--border-color);box-shadow:var(--shadow);max-height:90vh;overflow-y:auto}
.m-tl{font-size:18px;font-weight:700;margin-bottom:16px;color:var(--text-main);text-align:center}
.inp-g{margin-bottom:12px}
.inp-l{display:block;font-size:11px;color:var(--text-sub);margin-bottom:4px}
.inp{width:100%;padding:10px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:8px;color:var(--text-main);font-family:inherit;font-size:14px;outline:none}
.inp:focus{border-color:var(--accent)}
.cat-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.cat-chip{padding:6px 12px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:16px;font-size:12px;color:var(--text-sub);cursor:pointer;transition:all 0.2s;font-family:inherit}
.cat-chip:hover{border-color:var(--accent);color:var(--text-main)}
.cat-chip.on{background:var(--accent);border-color:var(--accent);color:white}
.add-cat-row{display:flex;gap:6px;margin-top:6px}
.add-cat-row input{flex:1;padding:6px 10px;font-size:12px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:8px;color:var(--text-main);font-family:inherit;outline:none}
.add-cat-row button{padding:6px 12px;background:var(--accent);color:#fff;border:none;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit}
.m-acts{display:flex;gap:10px;margin-top:20px}
.btn{flex:1;padding:12px;border-radius:8px;border:none;font-weight:600;font-family:inherit;cursor:pointer;font-size:14px}
.btn-c{background:var(--bg-input);color:var(--text-main)}
.btn-s{background:var(--accent);color:white}
.btn-s:disabled{opacity:0.7;cursor:wait}

/* NAV */
.nav{position:fixed;bottom:0;left:0;right:0;background:var(--nav-bg);backdrop-filter:blur(20px);border-top:1px solid var(--border-color);display:flex;justify-content:space-around;padding:8px 0;padding-bottom:calc(8px + env(safe-area-inset-bottom));z-index:9999}
.nb{background:none;border:none;display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:3px 8px}
.nb .ic{font-size:18px}.nb .lb{font-size:8px;font-weight:500}
.nb.on{color:var(--accent)}.nb.off{color:var(--text-muted)}

.pg{display:none}.pg.show{display:block}
.upd{font-size:9px;color:var(--text-muted);text-align:center;padding:8px}
.empty{text-align:center;padding:30px;color:var(--text-muted);font-size:12px}
</style>
</head>
<body>

<div id="loginScreen">
  <div class="l-box">
    <div class="l-ttl">ğŸ’° ShmoopsiePoo</div>
    <div class="l-sub">Yael & Amit</div>
    <div class="l-err" id="loginErr"></div>
    <input class="l-inp" type="text" id="lName" placeholder="×©× (Amit ××• Yael)" autocomplete="username">
    <input class="l-inp" type="password" id="lPass" placeholder="×¡×™×¡××”" autocomplete="current-password">
    <button class="l-btn" onclick="doAuth()">×”×ª×—×‘×¨</button>
  </div>
</div>

<div id="mainApp" style="display:none">

<div class="hdr">
  <div class="hdr-r">
    <div><div class="lg">ğŸ’° ShmoopsiePoo</div><div class="lg-s">Yael & Amit</div></div>
    <div style="display:flex;align-items:center;gap:4px">
      <button class="ref-btn" onclick="toggleTheme()" id="themeBtn">â˜€ï¸</button>
      <div class="plb" id="pLbl"></div>
    </div>
  </div>
</div>

<div class="dba">
  <label>×:</label><input type="date" class="di" id="sd">
  <label>×¢×“:</label><input type="date" class="di" id="ed">
  <button class="abtn" onclick="applyFilter()">×¡× ×Ÿ</button>
  <div class="prw" id="presets"></div>
</div>

<div class="ct">

<!-- SUMMARY PAGE -->
<div id="pgS" class="pg show">
  <div class="kg" id="kpis"></div>
  <div class="sbox" id="sBox"></div>
  <div class="cd"><div class="ttt">×”×›× ×¡×•×ª vs ×”×•×¦××•×ª ×—×•×“×©×™</div><div id="mChart" class="bars"></div></div>
  <div class="cd"><div class="ttt">×¤×™×œ×•×— ×”×›× ×¡×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”</div><div class="donut-w"><div class="donut" id="donut"></div><div id="piLg" style="flex:1"></div></div></div>
  <div class="cd"><div class="ttt">×˜×•×¤ ×”×•×¦××•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×”</div><div id="eCats"></div></div>
  <div class="upd" id="updTime"></div>
</div>

<!-- INCOME PAGE -->
<div id="pgI" class="pg">
  <input class="si" id="iSr" placeholder="ğŸ” ×—×™×¤×•×© ×”×›× ×¡×•×ª..." oninput="rInc()">
  <div id="sumI" class="summary-dash"></div>
  <div class="fr" id="iCh"></div>
  <div class="cn" id="iCn"></div>
  <div id="iLs"></div>
  <button class="fab" onclick="openModal('income')">+</button>
</div>

<!-- EXPENSE PAGE -->
<div id="pgE" class="pg">
  <input class="si" id="eSr" placeholder="ğŸ” ×—×™×¤×•×© ×”×•×¦××•×ª..." oninput="rExp()">
  <div id="sumE" class="summary-dash"></div>
  <div class="fr" id="eCh"></div>
  <div class="cn" id="eCn"></div>
  <div id="eLs"></div>
  <button class="fab exp" onclick="openModal('expense')">+</button>
</div>

<!-- DATA PAGE -->
<div id="pgT" class="pg">
  <div class="cd">
    <div class="ttt">ğŸ’¡ ×ª×•×‘× ×•×ª ×—×›××•×ª</div>
    <div id="insightsBox"></div>
  </div>
  <div class="tabs">
    <button class="tab on" id="tI" onclick="setTT('i')">×”×›× ×¡×•×ª</button>
    <button class="tab" id="tE" onclick="setTT('e')">×”×•×¦××•×ª</button>
  </div>
  <input class="si" id="tSr" placeholder="ğŸ” ×—×™×¤×•×©..." oninput="rTbl()">
  <div id="sumT" class="summary-dash"></div>
  <div class="fr" id="tCh"></div>
  <div class="cn" id="tCn"></div>
  <div id="tLs"></div>
</div>

</div>

<!-- ADD MODAL -->
<div class="modal" id="addModal">
  <div class="m-box">
    <div class="m-tl" id="modalTitle">×”×•×¡×¤×ª ×”×›× ×¡×”</div>
    <div class="inp-g"><label class="inp-l">×ª××¨×™×š</label><input type="date" class="inp" id="nDate"></div>
    <div class="inp-g"><label class="inp-l">×¡×›×•×</label><input type="number" class="inp" id="nAmt" placeholder="0" inputmode="numeric"></div>
    <div class="inp-g"><label class="inp-l">×ª×™××•×¨</label><input type="text" class="inp" id="nDesc" placeholder="××” ×–×”?"></div>
    <div class="inp-g">
      <label class="inp-l">×§×˜×’×•×¨×™×”</label>
      <div class="cat-chips" id="modalCats"></div>
      <div class="add-cat-row" style="margin-top:8px">
        <input type="text" id="newCatInput" placeholder="×§×˜×’×•×¨×™×” ×—×“×©×”...">
        <button onclick="addNewCat()">+</button>
      </div>
    </div>
    <div class="m-acts">
      <button class="btn btn-c" onclick="closeModal()">×‘×™×˜×•×œ</button>
      <button class="btn btn-s" id="saveBtn" onclick="saveItem()">×©××•×¨</button>
    </div>
  </div>
</div>

<!-- NAV -->
<div class="nav">
  <button class="nb on" id="n0" onclick="go('S')"><span class="ic">ğŸ“Š</span><span class="lb">×¡×™×›×•×</span></button>
  <button class="nb off" id="n1" onclick="go('I')"><span class="ic">ğŸ’°</span><span class="lb">×”×›× ×¡×•×ª</span></button>
  <button class="nb off" id="n2" onclick="go('E')"><span class="ic">ğŸ’¸</span><span class="lb">×”×•×¦××•×ª</span></button>
  <button class="nb off" id="n3" onclick="go('T')"><span class="ic">ğŸ“‹</span><span class="lb">× ×ª×•× ×™×</span></button>
</div>

</div>

<script>
// ========== FIREBASE ==========
firebase.initializeApp({
  apiKey:"AIzaSyDX0XDsaB5_JEDH7chBGMVyeUeqPnpwVlE",
  authDomain:"shmoopsiepoo1202.firebaseapp.com",
  databaseURL:"https://shmoopsiepoo1202-default-rtdb.europe-west1.firebasedatabase.app",
  projectId:"shmoopsiepoo1202",
  storageBucket:"shmoopsiepoo1202.firebasestorage.app",
  messagingSenderId:"589285900622",
  appId:"1:589285900622:web:1ac7d9b5181266f20b1e1f"
});
const db=firebase.database(),dbRef=db.ref('shmoopsiepoo');

// ========== CONSTANTS ==========
const USERS={'Amit':'1710','Yael':'1202'};
const IC=['#14b8a6','#f97316','#3b82f6','#a78bfa','#ec4899','#eab308'];
const EC=['#ef4444','#f97316','#eab308','#22c55e','#3b82f6','#8b5cf6','#ec4899','#14b8a6'];
const MH=['×™× ×•','×¤×‘×¨','××¨×¥','××¤×¨','×××™','×™×•× ','×™×•×œ','××•×’','×¡×¤×˜','××•×§','× ×•×‘','×“×¦×'];

// ========== STATE ==========
let currentUser='',s1='',s2='',curPg='S',curType='income',modalCat='';
let iCt='×”×›×œ',eCt='×”×›×œ',tT='i',tCt='×”×›×œ';
let D={income:[],expense:[],categories:{income:[],expense:[]}};

// ========== AUTH ==========
function doAuth(){
  const n=document.getElementById('lName').value.trim();
  const p=document.getElementById('lPass').value.trim();
  const err=document.getElementById('loginErr');
  if(!n||!p){err.textContent='×”×›× ×¡ ×©× ×•×¡×™×¡××”';err.style.display='block';return}
  if(USERS[n]&&USERS[n]===p){
    currentUser=n;localStorage.setItem('sp_user',n);err.style.display='none';showApp();
  }else{err.textContent='×©× ××• ×¡×™×¡××” ×©×’×•×™×™×';err.style.display='block'}
}
document.addEventListener('keydown',e=>{if(e.key==='Enter'&&document.getElementById('loginScreen').style.display!=='none')doAuth()});

function showApp(){
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('mainApp').style.display='block';
  startListening();
}
function logout(){localStorage.removeItem('sp_user');dbRef.off();location.reload()}

// ========== THEME ==========
function toggleTheme(){
  const isL=document.body.getAttribute('data-theme')==='light';
  if(isL){document.body.removeAttribute('data-theme');document.getElementById('themeBtn').textContent='â˜€ï¸';localStorage.setItem('sp_theme','dark')}
  else{document.body.setAttribute('data-theme','light');document.getElementById('themeBtn').textContent='ğŸŒ™';localStorage.setItem('sp_theme','light')}
}

// ========== FIREBASE LISTENER ==========
function startListening(){
  dbRef.on('value',snap=>{
    const v=snap.val()||{};
    D.income=v.income?Object.values(v.income):[];
    D.expense=v.expense?Object.values(v.expense):[];
    D.categories=v.categories||{income:[],expense:[]};
    if(!Array.isArray(D.categories.income))D.categories.income=Object.values(D.categories.income||{});
    if(!Array.isArray(D.categories.expense))D.categories.expense=Object.values(D.categories.expense||{});
    D.income.sort((a,b)=>(b.d||'').localeCompare(a.d||''));
    D.expense.sort((a,b)=>(b.d||'').localeCompare(a.d||''));
    document.getElementById('updTime').textContent='×¢×•×“×›×Ÿ: '+new Date().toLocaleString('he-IL')+' | '+D.income.length+' ×”×›× ×¡×•×ª, '+D.expense.length+' ×”×•×¦××•×ª';
    renderAll();
  });
  initDates();
}

// ========== DATES ==========
function initDates(){
  const n=new Date(),y=n.getFullYear(),m=n.getMonth();
  const toI=d=>d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  s1=toI(new Date(y,m,1));s2=toI(n);
  document.getElementById('sd').value=s1;document.getElementById('ed').value=s2;
  const P=[
    {l:'×”×—×•×“×©',s:s1,e:toI(new Date(y,m+1,0))},
    {l:'×—×•×“×© ×§×•×“×',s:`${m===0?y-1:y}-${String(m===0?12:m).padStart(2,'0')}-01`,e:`${m===0?y-1:y}-${String(m===0?12:m).padStart(2,'0')}-${new Date(m===0?y-1:y,m===0?12:m,0).getDate()}`},
    {l:'2026',s:'2026-01-01',e:'2026-12-31'},
    {l:'2025',s:'2025-01-01',e:'2025-12-31'},
    {l:'×”×›×œ',s:'2023-01-01',e:'2030-12-31'}
  ];
  document.getElementById('presets').innerHTML=P.map(p=>`<button class="pb" onclick="sP(this,'${p.s}','${p.e}')">${p.l}</button>`).join('');
  document.querySelector('.pb').classList.add('on');
  applyFilter();
}
function sP(el,a,b){document.querySelectorAll('.pb').forEach(x=>x.classList.remove('on'));el.classList.add('on');document.getElementById('sd').value=a;document.getElementById('ed').value=b;applyFilter()}
function applyFilter(){s1=document.getElementById('sd').value;s2=document.getElementById('ed').value;document.getElementById('pLbl').textContent=new Date(s1).toLocaleDateString('he-IL')+' - '+new Date(s2).toLocaleDateString('he-IL');iCt='×”×›×œ';eCt='×”×›×œ';tCt='×”×›×œ';renderAll()}

// ========== HELPERS ==========
function fmt(n){return'â‚ª'+Math.round(n).toLocaleString('he-IL')}
function fK(n){return n>=1e6?'â‚ª'+(n/1e6).toFixed(1)+'M':n>=1e3?'â‚ª'+Math.round(n/1000)+'K':'â‚ª'+n}
function inR(d){return d>=s1&&d<=s2}
function gF(){return{inc:D.income.filter(r=>inR(r.d)),exp:D.expense.filter(r=>inR(r.d))}}
function gMC(){return Math.max(1,Math.round((new Date(s2)-new Date(s1))/(30.44*864e5)))}
function esc(s){const d=document.createElement('div');d.textContent=s||'';return d.innerHTML}

function sumDash(id,arr,cls){
  const t=arr.reduce((s,x)=>s+x.a,0),c=arr.length,a=c>0?t/c:0;
  document.getElementById(id).innerHTML=`<div><div class="sd-ttl">×¡×”×´×›</div><div class="sd-val ${cls}">${fmt(t)}</div></div><div style="border-right:1px solid var(--border-color);border-left:1px solid var(--border-color)"><div class="sd-ttl">×¤×¢×•×œ×•×ª</div><div class="sd-val">${c}</div></div><div><div class="sd-ttl">×××•×¦×¢</div><div class="sd-val">${fmt(a)}</div></div>`;
}

// ========== MODAL ==========
function openModal(type){
  curType=type;modalCat='';
  document.getElementById('addModal').classList.add('open');
  document.getElementById('nDate').value=new Date().toISOString().split('T')[0];
  document.getElementById('nAmt').value='';
  document.getElementById('nDesc').value='';
  document.getElementById('newCatInput').value='';
  document.getElementById('modalTitle').textContent=type==='income'?'×”×•×¡×¤×ª ×”×›× ×¡×”':'×”×•×¡×¤×ª ×”×•×¦××”';
  renderModalCats();
}
function closeModal(){document.getElementById('addModal').classList.remove('open')}

function renderModalCats(){
  const cats=D.categories[curType]||[];
  document.getElementById('modalCats').innerHTML=cats.map(c=>`<div class="cat-chip ${modalCat===c?'on':''}" onclick="selCat('${esc(c)}')">${esc(c)}</div>`).join('');
}
function selCat(c){modalCat=modalCat===c?'':c;renderModalCats()}

function addNewCat(){
  const v=document.getElementById('newCatInput').value.trim();
  if(!v)return;
  const cats=D.categories[curType]||[];
  if(cats.includes(v)){alert('×§×™×™××ª');return}
  cats.push(v);
  dbRef.child('categories').child(curType).set(cats);
  document.getElementById('newCatInput').value='';
  modalCat=v;
}

function saveItem(){
  const d=document.getElementById('nDate').value;
  const a=parseFloat(document.getElementById('nAmt').value);
  const desc=document.getElementById('nDesc').value.trim();
  if(!d||!a||a<=0||!desc){alert('××œ× ×ª××¨×™×š, ×¡×›×•× ×•×ª×™××•×¨');return}
  if(!modalCat){alert('×‘×—×¨ ×§×˜×’×•×¨×™×”');return}
  const id=Date.now().toString();
  dbRef.child(curType).child(id).set({d,a,desc,c:modalCat,id,by:currentUser});
  if(curType==='income'&&typeof confetti==='function')confetti({particleCount:150,spread:70,origin:{y:0.6}});
  closeModal();
}

function deleteItem(type,id){if(confirm('×œ××—×•×§?'))dbRef.child(type).child(id).remove()}

// ========== ITEM CARD ==========
function mkC(r,t){
  const col=t==='i'?'gn':'or',sg=t==='i'?'+':'-',type=t==='i'?'income':'expense';
  return`<div class="dc"><div class="dr"><div style="flex:1;min-width:0"><div class="dtt">${esc(r.desc)}</div><div class="dm"><span>${r.d}</span><span class="dbg" style="background:${t==='i'?'#14b8a6':'#f97316'}">${esc(r.c)}</span>${r.by?'<span>'+esc(r.by)+'</span>':''}</div></div><div style="display:flex;align-items:center"><div class="da ${col}">${sg}${fmt(r.a)}</div><button class="del-btn" onclick="deleteItem('${type}','${r.id}')">ğŸ—‘</button></div></div></div>`;
}

// ========== RENDER ALL ==========
function renderAll(){
  const{inc,exp}=gF();
  const ti=inc.reduce((s,r)=>s+r.a,0),te=exp.reduce((s,r)=>s+r.a,0),pr=ti-te;

  // KPIs
  document.getElementById('kpis').innerHTML=`
    <div class="kp"><div class="kl">×¡×”×´×› ×”×›× ×¡×•×ª</div><div class="kv tl">${fK(ti)}</div></div>
    <div class="kp"><div class="kl">×¡×”×´×› ×”×•×¦××•×ª</div><div class="kv or">${fK(te)}</div></div>
    <div class="kp"><div class="kl">×¨×•×•×— ×œ×ª×§×•×¤×”</div><div class="kv ${pr>=0?'gn':'rd'}">${fK(pr)}</div></div>
    <div class="kp"><div class="kl">×××•×¦×¢ ×—×•×“×©×™</div><div class="kv bl">${fK(ti/gMC())}</div></div>`;

  // Summary box
  const icBC={};inc.forEach(r=>{const c=r.c||'××—×¨';icBC[c]=(icBC[c]||0)+r.a});
  let sb='<div class="sbt">×¡×™×›×•× ×”×›× ×¡×•×ª ×œ×ª×§×•×¤×”</div>';
  Object.entries(icBC).sort((a,b)=>b[1]-a[1]).forEach(([k,v])=>{sb+=`<div class="sr"><span>${esc(k)}</span><span class="tl">${fmt(v)}</span></div>`});
  sb+=`<div class="sr" style="border-top:2px solid var(--border-color);margin-top:4px;padding-top:4px"><span style="font-weight:700">×¡×”×´×›</span><span class="tl" style="font-weight:700;font-size:15px">${fmt(ti)}</span></div>`;
  document.getElementById('sBox').innerHTML=sb;

  // Charts
  rBar(inc,exp);rDonut(icBC,ti);rExpC(exp,te);

  // Insights
  genInsights(inc,exp);

  // Lists
  rInc();rExp();rTbl();
}

// ========== CHARTS ==========
function rBar(inc,exp){
  const mo={};
  let st=new Date(s1),en=new Date(s2);
  while(st<=en){const m=st.toISOString().slice(0,7);mo[m]={i:0,e:0};st.setMonth(st.getMonth()+1)}
  inc.forEach(r=>{const m=r.d.slice(0,7);if(mo[m])mo[m].i+=r.a});
  exp.forEach(r=>{const m=r.d.slice(0,7);if(mo[m])mo[m].e+=r.a});
  const ks=Object.keys(mo).sort(),mx=Math.max(...ks.map(k=>Math.max(mo[k].i,mo[k].e)),1);
  let h='';ks.forEach(k=>{
    const hi=Math.max(1,(mo[k].i/mx)*140),he=Math.max(1,(mo[k].e/mx)*140);
    h+=`<div class="bar-g"><div style="display:flex;gap:1px;align-items:flex-end;height:140px;width:100%"><div class="bar" style="height:${hi}px;background:#14b8a6;flex:1"></div><div class="bar" style="height:${he}px;background:#f97316;flex:1"></div></div><div class="bar-l">${MH[+k.split('-')[1]-1]}</div></div>`;
  });document.getElementById('mChart').innerHTML=h;
}

function rDonut(cats,total){
  const ar=Object.entries(cats).sort((a,b)=>b[1]-a[1]);
  let deg=0,grad='';
  ar.forEach((c,i)=>{const p=total>0?c[1]/total*360:0;grad+=`${IC[i%IC.length]} ${deg}deg ${deg+p}deg,`;deg+=p});
  document.getElementById('donut').style.background=ar.length?`conic-gradient(${grad.slice(0,-1)})`:'var(--bg-card)';
  let lg='';ar.forEach((c,i)=>{const p=total>0?(c[1]/total*100).toFixed(1):0;lg+=`<div class="dlg"><div class="ddot" style="background:${IC[i%IC.length]}"></div><div><div style="font-size:10px;font-weight:500">${esc(c[0])}</div><div style="font-size:9px;color:var(--text-muted)">${fmt(c[1])} (${p}%)</div></div></div>`});
  document.getElementById('piLg').innerHTML=lg;
}

function rExpC(exp,total){
  const cats={};exp.forEach(r=>{const c=r.c||'××—×¨';if(!cats[c])cats[c]={t:0,n:0};cats[c].t+=r.a;cats[c].n++});
  const ar=Object.entries(cats).sort((a,b)=>b[1].t-a[1].t),mx=ar[0]?ar[0][1].t:1;
  let h='';ar.slice(0,10).forEach(([k,v],i)=>{
    h+=`<div class="cr"><div class="crh"><span class="crn">${esc(k)}</span><span class="crv or">${fK(v.t)}</span></div><div class="crt"><div class="crf" style="width:${v.t/mx*100}%;background:${EC[i%EC.length]}"></div></div><div class="crs"><span>${v.n} ×¤×¢×•×œ×•×ª</span><span>${total>0?(v.t/total*100).toFixed(1):0}%</span></div></div>`;
  });document.getElementById('eCats').innerHTML=h||'<div class="empty">××™×Ÿ ×”×•×¦××•×ª</div>';
}

// ========== INSIGHTS ==========
function genInsights(inc,exp){
  const ti=inc.reduce((s,r)=>s+r.a,0),te=exp.reduce((s,r)=>s+r.a,0);
  let ins=[];
  if(ti>te&&te>0)ins.push(`×”××¦×‘ ××¢×•×œ×”! ×”×›× ×¡×•×ª ×’×‘×•×”×•×ª ××”×•×¦××•×ª ×‘-<b>${fmt(ti-te)}</b>`);
  if(te>ti)ins.push(`×©×™× ×œ×‘: ×”×•×¦××•×ª ×¢×œ×• ×¢×œ ×”×›× ×¡×•×ª ×‘-<b>${fmt(te-ti)}</b>`);
  const cats={};exp.forEach(r=>{cats[r.c]=(cats[r.c]||0)+r.a});
  const top=Object.entries(cats).sort((a,b)=>b[1]-a[1])[0];
  if(top)ins.push(`×”×”×•×¦××” ×”×’×“×•×œ×” ×‘×™×•×ª×¨: <b>${esc(top[0])}</b> (${fmt(top[1])})`);
  if(inc.length>0)ins.push(`×××•×¦×¢ ×”×›× ×¡×” ×‘×•×“×“×ª: <b>${fmt(ti/inc.length)}</b>`);
  document.getElementById('insightsBox').innerHTML=ins.length?ins.map(t=>`<div class="insight-item">${t}</div>`).join(''):'<div class="empty">××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™×</div>';
}

// ========== INCOME LIST ==========
function rInc(){
  const{inc}=gF();
  const cats=['×”×›×œ',...new Set(inc.map(r=>r.c).filter(Boolean))];
  document.getElementById('iCh').innerHTML=cats.map(c=>`<button class="fp ${iCt===c?'on':''}" onclick="iCt='${c}';rInc()">${esc(c)}</button>`).join('');
  const q=(document.getElementById('iSr').value||'').toLowerCase();
  const fl=inc.filter(r=>(iCt==='×”×›×œ'||r.c===iCt)&&(!q||r.desc.toLowerCase().includes(q)||r.c.toLowerCase().includes(q)));
  sumDash('sumI',fl,'gn');
  document.getElementById('iCn').textContent=fl.length+' ××ª×•×š '+inc.length;
  document.getElementById('iLs').innerHTML=fl.length?fl.map(r=>mkC(r,'i')).join(''):'<div class="empty">××™×Ÿ ×”×›× ×¡×•×ª ×‘×ª×§×•×¤×”</div>';
}

// ========== EXPENSE LIST ==========
function rExp(){
  const{exp}=gF();
  const cats=['×”×›×œ',...[...new Set(exp.map(r=>r.c).filter(Boolean))].sort()];
  document.getElementById('eCh').innerHTML=cats.map(c=>`<button class="fp ${eCt===c?'on':''}" onclick="eCt='${c}';rExp()">${esc(c)}</button>`).join('');
  const q=(document.getElementById('eSr').value||'').toLowerCase();
  const fl=exp.filter(r=>(eCt==='×”×›×œ'||r.c===eCt)&&(!q||r.desc.toLowerCase().includes(q)||r.c.toLowerCase().includes(q)));
  sumDash('sumE',fl,'or');
  document.getElementById('eCn').textContent=fl.length+' ××ª×•×š '+exp.length;
  document.getElementById('eLs').innerHTML=fl.length?fl.map(r=>mkC(r,'e')).join(''):'<div class="empty">××™×Ÿ ×”×•×¦××•×ª ×‘×ª×§×•×¤×”</div>';
}

// ========== DATA TABLE ==========
function setTT(t){tT=t;tCt='×”×›×œ';document.getElementById('tI').className='tab '+(t==='i'?'on':'');document.getElementById('tE').className='tab '+(t==='e'?'on':'');rTbl()}
function rTbl(){
  const{inc,exp}=gF(),recs=tT==='i'?inc:exp;
  const cats=['×”×›×œ',...[...new Set(recs.map(r=>r.c).filter(Boolean))].sort()];
  document.getElementById('tCh').innerHTML=cats.map(c=>`<button class="fp ${tCt===c?'on':''}" onclick="tCt='${c}';rTbl()">${esc(c)}</button>`).join('');
  const q=(document.getElementById('tSr').value||'').toLowerCase();
  const fl=recs.filter(r=>(tCt==='×”×›×œ'||r.c===tCt)&&(!q||r.desc.toLowerCase().includes(q)||r.c.toLowerCase().includes(q)));
  sumDash('sumT',fl,tT==='i'?'gn':'or');
  document.getElementById('tCn').textContent=fl.length+' ×ª×•×¦××•×ª';
  document.getElementById('tLs').innerHTML=fl.length?fl.map(r=>mkC(r,tT)).join(''):'<div class="empty">××™×Ÿ × ×ª×•× ×™×</div>';
}

// ========== NAV ==========
function go(p){
  curPg=p;
  const pages=['S','I','E','T'];
  pages.forEach((x,i)=>{
    document.getElementById('pg'+x).className='pg'+(x===p?' show':'');
    document.getElementById('n'+i).className='nb '+(x===p?'on':'off');
  });
  window.scrollTo(0,0);
}

// ========== INIT ==========
(function(){
  if(localStorage.getItem('sp_theme')==='light'){document.body.setAttribute('data-theme','light');document.getElementById('themeBtn').textContent='ğŸŒ™'}
  const saved=localStorage.getItem('sp_user');
  if(saved&&USERS[saved]){currentUser=saved;showApp()}
})();
</script>
</body>
</html>
