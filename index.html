<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-status-bar-style" content="black-translucent">
<title>REL - × ×™×”×•×œ ×¤×™× × ×¡×™ ×¤×¨×™××™×•×</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;600;700;800&display=swap');

:root {
    --bg-body: #0f172a;
    --bg-card: #1e293b;
    --bg-input: rgba(255,255,255,0.05);
    --border-color: rgba(255,255,255,0.1);
    --text-main: #f1f5f9;
    --text-sub: #94a3b8;
    --text-muted: #64748b;
    --accent: #14b8a6;
    --shadow: 0 10px 25px rgba(0,0,0,0.5);
    --modal-bg: rgba(15,23,42,0.9);
    --nav-bg: rgba(15,23,42,0.95);
}

[data-theme="light"] {
    --bg-body: #f1f5f9;
    --bg-card: #ffffff;
    --bg-input: #e2e8f0;
    --border-color: #cbd5e1;
    --text-main: #0f172a;
    --text-sub: #475569;
    --text-muted: #94a3b8;
    --accent: #0d9488;
    --shadow: 0 4px 15px rgba(0,0,0,0.1);
    --modal-bg: rgba(241,245,249,0.9);
    --nav-bg: rgba(255,255,255,0.95);
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg-body);color:var(--text-main);font-family:'Rubik',system-ui,sans-serif;direction:rtl;min-height:100vh;overflow-x:hidden;padding-bottom:90px;transition:background 0.3s, color 0.3s}
::-webkit-scrollbar{display:none}

#googleLoginScreen {position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-body);z-index:100000;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px}
.l-box {background:var(--bg-card);padding:40px 30px;border-radius:24px;width:100%;max-width:340px;text-align:center;box-shadow:var(--shadow);border:1px solid var(--border-color)}
.l-ttl {font-size:28px;font-weight:800;margin-bottom:8px;background:linear-gradient(135deg, #14b8a6, #3b82f6);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.l-sub {font-size:14px;color:var(--text-sub);margin-bottom:32px;line-height:1.4;}

.summary-dash {display: flex; justify-content: space-between; background: var(--bg-card); padding: 12px; border-radius: 12px; margin-bottom: 12px; border: 1px solid var(--border-color); text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
.summary-dash > div {flex: 1;}
.sd-ttl {font-size: 11px; color: var(--text-sub); margin-bottom: 4px; font-weight:500;}
.sd-val {font-size: 16px; font-weight: 800; color: var(--text-main);}

.insight-item {font-size:13px; margin-bottom:8px; padding:10px 12px; background:var(--bg-input); border-radius:8px; border-right:4px solid var(--accent); line-height:1.4; color:var(--text-main);}

.loader{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--bg-body);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999}
.loader.hide{display:none}
.spinner{width:40px;height:40px;border:3px solid var(--border-color);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

.fab{position:fixed;bottom:90px;left:20px;width:56px;height:56px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;font-size:30px;box-shadow:0 4px 12px rgba(20,184,166,0.4);z-index:1000;border:none;cursor:pointer;transition:transform 0.2s}
.fab:active{transform:scale(0.95)}

.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:var(--modal-bg);z-index:2000;display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(5px)}
.modal.open{display:flex}
.m-box{background:var(--bg-card);width:100%;max-width:400px;border-radius:16px;padding:20px;border:1px solid var(--border-color);box-shadow:var(--shadow)}
.m-tl{font-size:18px;font-weight:700;margin-bottom:16px;color:var(--text-main);text-align:center}
.inp-g{margin-bottom:12px}
.inp-l{display:block;font-size:11px;color:var(--text-sub);margin-bottom:4px}
.inp{width:100%;padding:10px;background:var(--bg-input);border:1px solid var(--border-color);border-radius:8px;color:var(--text-main);font-family:inherit;font-size:14px;outline:none}

.hdr{background:linear-gradient(135deg,#134e4a,#0d9488,#134e4a);padding:16px 16px 12px;padding-top:env(safe-area-inset-top);position:sticky;top:0;z-index:50;box-shadow:0 2px 12px rgba(13,148,136,0.3)}
.hdr-r{display:flex;align-items:center;justify-content:space-between}
.lg{font-size:18px;font-weight:800;color:#fff}.lg-s{font-size:10px;color:rgba(255,255,255,0.8)}
.ref-btn{background:rgba(255,255,255,0.15);border:none;color:#fff;border-radius:8px;padding:4px 10px;font-size:14px;font-family:inherit;cursor:pointer;margin-right:5px}

.ct{padding:12px}
.kg{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.kp{background:var(--bg-input);border-radius:12px;padding:12px 14px;flex:1 1 45%;min-width:135px;border:1px solid var(--border-color)}
.kl{font-size:10px;color:var(--text-sub);margin-bottom:2px;font-weight:500}
.kv{font-size:20px;font-weight:700;}

.cd{background:var(--bg-card);border-radius:12px;padding:14px;margin-bottom:12px;border:1px solid var(--border-color)}
.ttt{font-size:12px;font-weight:600;margin-bottom:10px;color:var(--text-main)}

.bars{display:flex;align-items:flex-end;gap:3px;height:160px;padding:0 4px;border-bottom:1px solid var(--border-color)}
.bar-g{flex:1;display:flex;flex-direction:column;align-items:center;gap:1px;height:100%;justify-content:flex-end;min-width:0}
.bar{border-radius:2px 2px 0 0;min-height:1px;width:100%;max-width:14px}
.bar-l{font-size:7px;color:var(--text-muted);margin-top:3px;text-align:center}

.dc{background:var(--bg-card);border-radius:10px;padding:9px 11px;margin-bottom:5px;border:1px solid var(--border-color)}
.dr{display:flex;justify-content:space-between;align-items:center}
.dtt{font-size:12px;font-weight:600;color:var(--text-main)}
.da{font-size:13px;font-weight:700;}
.tl{color:var(--accent)}.or{color:#f97316}.gn{color:#34d399}.rd{color:#f87171}

.nav{position:fixed;bottom:0;left:0;right:0;background:var(--nav-bg);backdrop-filter:blur(20px);border-top:1px solid var(--border-color);display:flex;justify-content:space-around;padding:8px 0;padding-bottom:calc(8px + env(safe-area-inset-bottom));z-index:9999}
.nb{background:none;border:none;display:flex;flex-direction:column;align-items:center;cursor:pointer;padding:3px 8px;color:var(--text-muted)}
.nb.on{color:var(--accent)}
.pg{display:none}.pg.show{display:block}
</style>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>
<body>

<div id="googleLoginScreen">
    <div class="l-box">
        <div class="l-ttl">REL - Business</div>
        <div class="l-sub">×›× ×™×¡×” ×××•×‘×˜×—×ª ×œ××¢×¨×›×ª × ×™×”×•×œ ×”××™×¨×•×¢×™×.</div>
        <div id="g_id_onload" data-client_id="943081015380-nhhrgi95qj8lhlt783ie62lvjfvau6cs.apps.googleusercontent.com" data-callback="handleCredentialResponse"></div>
        <div class="g_id_signin" data-type="standard"></div>
    </div>
</div>

<div id="mainApp" style="display:none">
<div class="loader" id="loader"><div class="spinner"></div><div class="loader-txt">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div></div>

<div class="hdr">
    <div class="hdr-r">
        <div><div class="lg">REL Management</div><div class="lg-s">×¤×¨×•×™×§×˜ ××™×¨×•×¢×™×</div></div>
        <div style="display:flex;gap:8px">
            <button class="ref-btn" onclick="toggleTheme()" id="themeBtn">â˜€ï¸</button>
            <button class="ref-btn" onclick="loadData()">ğŸ”„</button>
        </div>
    </div>
</div>

<div class="ct">
    <div id="pgS" class="pg show">
        <div class="kg" id="kpis"></div>
        <div class="cd"><div class="ttt">×¨×•×•×— × ×§×™ ×©× ×ª×™</div><div id="mCh" class="bars"></div></div>
        <div class="cd" id="fullSummary"></div>
    </div>

    <div id="pgD" class="pg">
        <div class="cd"><div class="ttt">ğŸ’¡ ×ª×•×‘× ×•×ª ×—×›××•×ª</div><div id="insightsBox"></div></div>
        <div class="cd"><div class="ttt">×”×™×¡×˜×•×¨×™×™×ª ×—×•×“×©×™×</div><div id="historyList"></div></div>
    </div>

    <div id="pgI" class="pg">
        <div class="cd"><div class="ttt">×”×•×¡×¤×ª ××™×¨×•×¢ ×—×“×©</div>
            <div class="inp-g"><label class="inp-l">×ª××¨×™×š</label><input type="date" class="inp" id="nDate"></div>
            <div class="inp-g"><label class="inp-l">×©× ×××Ÿ / ××™×¨×•×¢</label><input type="text" class="inp" id="nArtist" placeholder="××™ ××•×¤×™×¢?"></div>
            <div class="inp-g"><label class="inp-l">××™×§×•×</label><input type="text" class="inp" id="nLoc" placeholder="××™×¤×”?"></div>
            <div class="inp-g"><label class="inp-l">×¡×•×’ ××¢×´×</label><select class="inp" id="nVat"><option value="×¨×’×™×œ">×¨×’×™×œ</option><option value="×¤×˜×•×¨">×¤×˜×•×¨</option></select></div>
            <div class="inp-g"><label class="inp-l">×¡×›×•× ×œ×¤× ×™ ××¢×´×</label><input type="number" class="inp" id="nAmt" placeholder="0"></div>
            <button class="inp" style="background:var(--accent);color:white;font-weight:700;border:none" onclick="saveData()">×©××•×¨ ××™×¨×•×¢</button>
        </div>
    </div>
</div>

<div class="nav">
    <button class="nb on" id="n0" onclick="go('S')">ğŸ“Š ×¡×™×›×•×</button>
    <button class="nb off" id="n1" onclick="go('D')">ğŸ“ˆ ×ª×•×‘× ×•×ª</button>
    <button class="nb off" id="n2" onclick="go('I')">â• ×”×•×¡×¤×”</button>
</div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwaISO7HN3efiEnT6TOG6EA4kH9pZbupL9851qLBttGU0CcCToiMhkJ2NCCSCWVpiQ7nQ/exec";
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRPtRqvwEmfwI4ePjdlg0s8jYcLhCMyWNWWomaOPinnfGlP8-YoAg5RxR02_HXgXpK4rdPqOQmxEm3I/pub?gid=1566301765&single=true&output=csv";

let fullData = [];

async function handleCredentialResponse(response) {
    const payload = JSON.parse(atob(response.credential.split('.')[1]));
    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: "checkAuth", email: payload.email }) });
    const auth = await res.text();
    if (auth.trim() === "authorized") {
        localStorage.setItem('auth_rel_full', 'true');
        location.reload();
    } else { alert("×’×™×©×” × ×“×—×ª×”"); }
}

function toggleTheme() {
    const isLight = document.body.getAttribute('data-theme') === 'light';
    document.body.setAttribute('data-theme', isLight ? 'dark' : 'light');
    document.getElementById('themeBtn').textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
}

async function loadData() {
    document.getElementById('loader').classList.remove('hide');
    try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        const rows = text.split('\n').map(r => r.split(',')).filter(r => r[0] && r[0] !== '×—×•×“×©');
        fullData = rows;
        renderAll();
        document.getElementById('loader').classList.add('hide');
    } catch(e) { alert("×©×’×™××” ×‘×˜×¢×™× ×”"); }
}

function renderAll() {
    const parseNum = (v) => parseFloat((v||'0').replace(/[â‚ª,%\s]/g, "")) || 0;
    const current = fullData[fullData.length - 1];
    
    // KPIs
    document.getElementById('kpis').innerHTML = `
        <div class="kp"><div class="kl">×”×›× ×¡×•×ª ×”×—×•×“×©</div><div class="kv tl">â‚ª${parseNum(current[1]).toLocaleString()}</div></div>
        <div class="kp"><div class="kl">×¨×•×•×— × ×§×™</div><div class="kv gn">â‚ª${parseNum(current[7]).toLocaleString()}</div></div>
    `;

    // Bar Chart
    const maxVal = Math.max(...fullData.map(r => Math.abs(parseNum(r[7]))), 1);
    let bars = '';
    fullData.forEach(r => {
        const val = parseNum(r[7]);
        const h = (Math.abs(val) / maxVal) * 140;
        bars += `<div class="bar-g"><div class="bar" style="height:${h}px; background:${val>=0?'#14b8a6':'#f87171'}"></div><div class="bar-l">${r[0].slice(0,3)}</div></div>`;
    });
    document.getElementById('mCh').innerHTML = bars;

    // Insights
    let insights = `<div class="insight-item">×”×—×•×“×© ×”×¨×•×•×—×ª <b>â‚ª${parseNum(current[7]).toLocaleString()}</b> × ×§×™.</div>`;
    if(parseNum(current[7]) > parseNum(fullData[fullData.length-2][7])) {
        insights += `<div class="insight-item" style="border-right-color:#34d399">××’××ª ×©×™×¤×•×¨! ×”×¨×•×•×— ×’×‘×•×” ×™×•×ª×¨ ××—×•×“×© ×©×¢×‘×¨.</div>`;
    }
    document.getElementById('insightsBox').innerHTML = insights;

    // Full Detail
    let det = `<div class="ttt">×¤×™×¨×•×˜ ××œ× - ${current[0]}</div>`;
    const labs = ["×”×›× ×¡×•×ª", "×”×•×¦××•×ª ××™×¨×•×¢×™×", "×¨×•×•×— ×’×•×œ××™", "××©×¨×“", "××©×›×•×¨×•×ª", "××™×¡×™×", "×¨×•×•×— × ×§×™"];
    labs.forEach((l, i) => {
        det += `<div class="dr" style="padding:10px 0; border-bottom:1px solid var(--border-color)"><span>${l}</span><span style="font-weight:700">${current[i+1]}</span></div>`;
    });
    document.getElementById('fullSummary').innerHTML = det;
}

async function saveData() {
    const data = {
        type: 'event',
        date: document.getElementById('nDate').value,
        artist: document.getElementById('nArtist').value,
        location: document.getElementById('nLoc').value,
        vatType: document.getElementById('nVat').value,
        amountBefore: document.getElementById('nAmt').value
    };
    if(!data.date || !data.amountBefore) return alert("××œ× ×ª××¨×™×š ×•×¡×›×•×");
    
    const btn = event.target;
    btn.disabled = true; btn.innerText = "×©×•××¨...";
    
    try {
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data) });
        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
        alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
        location.reload();
    } catch(e) { alert("×©×’×™××”"); btn.disabled = false; btn.innerText = "×©××•×¨ ××™×¨×•×¢"; }
}

function go(p) {
    document.querySelectorAll('.pg').forEach(x => x.classList.remove('show'));
    document.getElementById('pg'+p).classList.add('show');
    document.querySelectorAll('.nb').forEach((b,i) => b.classList.toggle('on', b.id === 'n'+(['S','D','I'].indexOf(p))));
}

document.addEventListener('DOMContentLoaded', () => {
    if (localStorage.getItem('auth_rel_full') === 'true') {
        document.getElementById('googleLoginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        loadData();
    }
});
</script>
</body>
</html>
